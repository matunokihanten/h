<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®— Pro - ç ã®é‡ãªã‚Šå®Œå…¨ä¿®æ­£ç‰ˆ</title>
  <style>
    :root { --primary: #6c5ce7; --bg: #f0f2f5; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-size: 13px; }
    body {
      background: linear-gradient(135deg, #74b9ff, #a29bfe);
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px;
      overflow: hidden;
    }
    h1 { font-size: 1.1rem; margin-bottom: 2px; color: white; }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px; padding: 6px 10px; width: 100%; max-width: 360px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .stats-area { font-size: 10px; color: #666; text-align: center; margin-bottom: 4px; border-bottom: 1px solid #eee; }
    label { font-weight: bold; display: block; margin: 2px 0; font-size: 11px; }
    
    .grid { display: grid; gap: 4px; margin-bottom: 4px; }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    
    button { padding: 5px 2px; border: none; border-radius: 4px; background: #eee; cursor: pointer; }
    button.selected { background: var(--primary); color: white; font-weight: bold; }
    
    .opt-row { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; }

    #startBtn { background: #2ecc71; color: white; font-size: 14px; font-weight: bold; padding: 8px; width: 100%; border-radius: 6px; }

    /* ãã‚ã°ã‚“æç”»ã®ä¿®æ­£ï¼šé‡ãªã‚Šé˜²æ­¢ */
    #flashSection { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; }
    #flashDisplay { font-size: 3rem; font-weight: bold; height: 60px; margin-top: 10px; }
    
    #abacusContainer {
      display: flex; flex-direction: row-reverse; justify-content: center; 
      gap: 3px; padding: 12px 5px; background: #000; border-radius: 10px; 
      width: 100%; margin-top: 5px; border: 4px solid #333;
      box-shadow: inset 0 0 15px rgba(0,0,0,1);
    }
    .abacus-col { display: flex; flex-direction: column; align-items: center; flex: 1; max-width: 28px; position: relative; height: 120px; }
    
    /* è»¸ã®è‰²ã‚’å°‘ã—è½ã¨ã—ã¦ç ã‚’æµ®ã‹ã›ã‚‹ */
    .abacus-col::after { 
      content: ""; position: absolute; width: 3px; height: 100%; 
      background: #333; z-index: 1; left: 50%; transform: translateX(-50%); 
    }
    
    .bead { 
      width: 100%; height: 14px; border-radius: 6px; z-index: 3; 
      transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1); 
      opacity: 0.15; border: 1px solid rgba(0,0,0,0.5); 
      position: relative;
    }

    .bead.active { 
      opacity: 1; 
      border: 1px solid rgba(255,255,255,0.3); 
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .bead.five { background: radial-gradient(circle at 30% 30%, #ff5e57, #c0392b); }
    .bead.one { background: radial-gradient(circle at 30% 30%, #ffd32a, #d4ac0d); }
    
    /* æ¢ï¼ˆç™½ã„ç·šï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã€‚ç ã®ä¸‹ã«æ½œã‚Šè¾¼ã¾ãªã„ã‚ˆã† z-index ã‚’èª¿æ•´ */
    .divider { 
      width: 140%; height: 7px; background: #fefefe; margin: 3px 0; 
      z-index: 2; border-radius: 1px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.8);
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #aaa;
    }
    
    /* å…¥åŠ›ç”»é¢ */
    #inputSection, #resultSection { display: none; flex-direction: column; align-items: center; }
    #answerDisplay { width: 100%; font-size: 24px; text-align: right; padding: 8px; margin-bottom: 5px; border: 2px solid var(--primary); border-radius: 8px; }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 100%; }
    .keypad button { padding: 12px; font-size: 18px; background: #ddd; }
  </style>
</head>
<body>

  <h1>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®—</h1>

  <div id="settings" class="card">
    <div class="stats-area" id="statsDisplay">æœ€é«˜: 0 | æ­£ç­”ç‡: 0%</div>
    
    <div class="opt-row">
      <label>é€£ç¶š</label><input type="checkbox" id="continuous">
      <label>æ®‹åƒãƒˆãƒ¬</label><input type="checkbox" id="abacusMode" checked>
      <label>è‡ªå‹•æ˜‡æ ¼</label><input type="checkbox" id="autoLevel">
    </div>

    <label>æ¡æ•°</label>
    <div class="grid grid-5" id="digitGrid">
      <button data-val="1" class="selected">1</button><button data-val="2">2</button><button data-val="3">3</button><button data-val="4">4</button><button data-val="5">5</button><button data-val="6">6</button><button data-val="7">7</button><button data-val="8">8</button><button data-val="9">9</button><button data-val="10">10</button>
    </div>

    <label>å‡ºé¡Œæ•°</label>
    <div class="grid grid-4" id="questGrid">
      <button data-val="1">1</button><button data-val="2">2</button><button data-val="3">3</button><button data-val="5" class="selected">5</button><button data-val="10">10</button><button data-val="15">15</button><button data-val="20">20</button><button data-val="30">30</button>
    </div>

    <label>è¡¨ç¤ºç§’æ•°</label>
    <div class="grid grid-4" id="timeGrid">
      <button data-val="0.3">0.3</button><button data-val="0.5">0.5</button><button data-val="1">1.0</button><button data-val="2" class="selected">2.0</button><button data-val="3">3.0</button><button data-val="5">5.0</button><button data-val="7">7.0</button><button data-val="10">10.0</button>
    </div>

    <label>éŸ³å£°</label>
    <div class="grid grid-2" id="audioGrid">
      <button data-val="off" class="selected">OFF</button><button data-val="on">ON</button>
    </div>

    <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <div id="flashSection" class="card">
    <div id="flashDisplay"></div>
    <div id="abacusContainer"></div>
  </div>

  <div id="inputSection" class="card">
    <input type="text" id="answerDisplay" readonly>
    <div class="keypad">
      <button class="k">1</button><button class="k">2</button><button class="k">3</button><button class="k">4</button><button class="k">5</button><button class="k">6</button><button class="k">7</button><button class="k">8</button><button class="k">9</button><button class="k" style="background:#fab1a0">C</button><button class="k">0</button><button class="k" style="background:#ffeaa7">â†</button>
    </div>
    <button id="checkBtn" style="background:var(--primary); color:white; width:100%; padding:10px; margin-top:8px; border-radius:8px;">ç­”ãˆåˆã‚ã›</button>
  </div>

  <div id="resultSection" class="card" style="text-align:center">
    <div id="resTitle" style="font-size:20px; font-weight:bold; margin-bottom:10px;"></div>
    <div id="resDetail" style="font-size:12px; margin-bottom:15px; color:#555"></div>
    <button id="retryBtn" style="background:var(--primary); color:white; padding:10px; width:100%; border-radius:6px;">æ¬¡ã¸ / æˆ»ã‚‹</button>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    let config = { digits: 1, count: 5, time: 2, audio: false };
    let numbers = [];
    let sum = BigInt(0);

    [ ['digitGrid','digits'], ['questGrid','count'], ['timeGrid','time'], ['audioGrid','audio'] ].forEach(item => {
      $(item[0]).querySelectorAll('button').forEach(btn => {
        btn.onclick = () => {
          $(item[0]).querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          let val = btn.dataset.val;
          config[item[1]] = (val === 'on' ? true : (val === 'off' ? false : parseFloat(val)));
        };
      });
    });

    function speakPromise(text) {
      return new Promise((resolve) => {
        if (!config.audio) { resolve(); return; }
        window.speechSynthesis.cancel();
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'ja-JP';
        ut.rate = 1.5;
        ut.onend = resolve;
        ut.onerror = resolve;
        window.speechSynthesis.speak(ut);
        setTimeout(resolve, 2000);
      });
    }

    /* ç ã®ç§»å‹•é‡ã‚’ãƒŸãƒªå˜ä½ã§ä¿®æ­£ */
    function renderAbacus(valStr) {
      const container = $('abacusContainer');
      container.innerHTML = '';
      const s = valStr.toString().padStart(10, '0');
      s.split('').reverse().forEach(digit => {
        const v = parseInt(digit);
        const col = document.createElement('div'); col.className = 'abacus-col';
        
        // äº”ç ã‚¨ãƒªã‚¢
        const up = document.createElement('div'); up.style.cssText='height:35px; width:100%; display:flex; justify-content:center; position:relative;';
        const fv = document.createElement('div'); fv.className = 'bead five' + (v>=5?' active':'');
        // äº”ç ãŒæ¢ã«é‡ãªã‚‰ãªã„çµ¶å¦™ãªåœæ­¢ä½ç½®
        fv.style.transform = v>=5 ? 'translateY(16px)' : 'translateY(0px)';
        up.appendChild(fv); col.appendChild(up);

        // æ¢
        const div = document.createElement('div'); div.className='divider'; col.appendChild(div);

        // ä¸€ç ã‚¨ãƒªã‚¢
        const lw = document.createElement('div'); lw.style.cssText='height:75px; width:100%; display:flex; flex-direction:column; justify-content:flex-end; align-items:center; position:relative;';
        const lowV = v % 5;
        for(let i=1; i<=4; i++) {
          const b = document.createElement('div'); b.className = 'bead one' + (i<=lowV?' active':'');
          // ä¸€ç ãŒæ¢ã®ã™ãä¸‹ã§æ­¢ã¾ã‚‹ã‚ˆã†ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã‚’èª¿æ•´ï¼ˆæ¢ã®åšã¿7pxã‚’è€ƒæ…®ï¼‰
          let off = (i<=lowV) ? -((4-lowV)*2 + 20) : 0;
          b.style.transform = `translateY(${off}px)`;
          lw.appendChild(b);
        }
        col.appendChild(lw); container.appendChild(col);
      });
    }

    $('startBtn').onclick = async () => {
      $('settings').style.display = 'none';
      $('flashSection').style.display = 'flex';
      numbers = []; sum = BigInt(0);
      for(let i=0; i<config.count; i++) {
        let n = Math.floor(Math.random() * (Math.pow(10, config.digits) - Math.pow(10, config.digits-1))) + Math.pow(10, config.digits-1);
        numbers.push(n); sum += BigInt(n);
      }
      const disp = $('flashDisplay');
      if($('abacusMode').checked) renderAbacus("0");
      for(let i=3; i>0; i--) { disp.textContent = i; await new Promise(r=>setTimeout(r, 600)); }
      disp.textContent = "Go!"; await new Promise(r=>setTimeout(r, 400));
      let curSum = BigInt(0);
      for(let n of numbers) {
        curSum += BigInt(n);
        disp.textContent = n;
        disp.style.opacity = 1;
        if($('abacusMode').checked) renderAbacus(curSum.toString());
        await Promise.all([speakPromise(n.toString()), new Promise(r => setTimeout(r, config.time * 1000))]);
        disp.style.opacity = 0;
        await new Promise(r=>setTimeout(r, 150));
      }
      $('flashSection').style.display = 'none';
      $('inputSection').style.display = 'flex';
      $('answerDisplay').value = '';
    };

    document.querySelectorAll('.k').forEach(k => {
      k.onclick = () => {
        let d = $('answerDisplay');
        if(k.textContent === 'C') d.value = '';
        else if(k.textContent === 'â†') d.value = d.value.slice(0,-1);
        else d.value += k.textContent;
      };
    });

    $('checkBtn').onclick = () => {
      const isCorrect = $('answerDisplay').value === sum.toString();
      $('inputSection').style.display = 'none';
      $('resultSection').style.display = 'flex';
      $('resTitle').textContent = isCorrect ? "æ­£è§£ï¼ğŸ‰" : "ä¸æ­£è§£...ğŸ˜¢";
      $('resTitle').style.color = isCorrect ? "#2ecc71" : "#e74c3c";
      $('resDetail').innerHTML = `æ­£è§£: ${sum}<br>å¼: ${numbers.join('+')}`;
      if($('continuous').checked) {
        setTimeout(() => { if($('resultSection').style.display === 'flex') $('retryBtn').click(); }, 2000);
      }
    };

    $('retryBtn').onclick = () => {
      $('resultSection').style.display = 'none';
      $('settings').style.display = 'block';
    };
  </script>
</body>
</html>
