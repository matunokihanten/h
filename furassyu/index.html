<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®— Pro + æ®‹åƒãƒˆãƒ¬</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #7F7FD5, #86A8E7, #91EAE4);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 5px;
      -webkit-tap-highlight-color: transparent;
    }
    h1 { margin: 5px 0; font-size: 1.8em; }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 12px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 8px;
    }
    #settings { display: flex; flex-direction: column; gap: 10px; }
    #settings label { font-weight: bold; display: block; margin-bottom: 3px; font-size: 0.9em; }
    .grid-select { width: 100%; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .grid-select.full-width { grid-template-columns: repeat(5, 1fr); }
    .grid-select.double-grid { grid-template-columns: repeat(2, 1fr); }
    .grid-select button {
      padding: 7px; background: #eee; border: none; border-radius: 6px;
      cursor: pointer; transition: background 0.2s; font-size: 0.8em;
    }
    .grid-select button.selected { background: #86A8E7; color: white; }
    
    .option-row { display: flex; justify-content: space-between; align-items: center; background: #f0f4ff; padding: 8px; border-radius: 6px; }
    .stats-area { font-size: 0.8em; color: #555; border-top: 1px solid #eee; pt: 5px; margin-top: 5px; }

    #flashSection { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 220px; }
    #flashDisplay { font-size: 4rem; font-weight: bold; margin: 5px 0; opacity: 0; }
    
    #abacusContainer {
      display: flex;
      flex-direction: row-reverse;
      justify-content: center;
      gap: 12px;
      margin-top: 10px;
      padding: 15px;
      background: #222;
      border: 4px solid #444;
      border-radius: 10px;
      min-height: 140px;
    }
    .abacus-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 24px;
      height: 110px;
      position: relative;
    }
    .abacus-column::before {
      content: "";
      position: absolute;
      width: 4px;
      height: 100%;
      background: #555;
      z-index: 0;
    }
    .abacus-bead {
      width: 22px;
      height: 14px;
      border: 1px solid #000;
      border-radius: 6px;
      z-index: 1;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s, opacity 0.3s;
      opacity: 0.3;
    }
    .five-bead { background: #ff3333; }
    .one-bead { background: #ffcc00; }
    
    .abacus-bead.active { 
      opacity: 1;
      box-shadow: 0 0 8px rgba(255,255,255,0.4);
    }
    .abacus-divider {
      width: 32px;
      height: 8px;
      background: #fff;
      margin: 4px 0;
      z-index: 2;
    }
    .upper-area { height: 25px; display: flex; align-items: flex-start; width: 100%; justify-content: center; }
    .lower-area { height: 75px; display: flex; flex-direction: column; width: 100%; align-items: center; justify-content: flex-end; }

    #inputSection { display: none; flex-direction: column; align-items: center; }
    #answerDisplay {
      width: 100%; max-width: 380px; font-size: 2em; border: 2px solid #ccc;
      border-radius: 8px; text-align: right; padding: 8px; margin-bottom: 10px; background: #f9f9f9;
    }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-width: 380px; margin-bottom: 8px; }
    .keypad button { padding: 15px 10px; font-size: 1.5em; background: #e0e0e0; border: none; border-radius: 8px; cursor: pointer; }
    #resultSection { display: none; text-align: center; }
    .review-text { font-size: 0.9em; color: #666; margin: 10px 0; word-break: break-all; }
    button.action-btn {
      padding: 10px 20px; font-size: 1em; background: #86A8E7; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px;
    }
    .quit-btn { background: #ff7675 !important; margin-top: 10px; }
  </style>
</head>
<body ondblclick="return false;">
  <h1>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æš—ç®—</h1>
  
  <div id="settings" class="card">
    <div class="stats-area" id="statsDisplay">
      æœ€é«˜ã‚¹ã‚³ã‚¢: 0 | ç›´è¿‘æ­£ç­”ç‡: 0%
    </div>
    <div>
      <label>ãƒ¢ãƒ¼ãƒ‰é¸æŠ</label>
      <div class="grid-select double-grid" id="modeGrid">
        <button data-value="flash" class="selected">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¢ãƒ¼ãƒ‰</button>
        <button data-value="audio">èãå–ã‚Šãƒ¢ãƒ¼ãƒ‰</button>
      </div>
    </div>
    
    <div class="option-row">
      <label for="autoLevel">è‡ªå‹•æ˜‡æ ¼ãƒ¢ãƒ¼ãƒ‰</label>
      <input type="checkbox" id="autoLevel">
    </div>
    <div class="option-row">
      <label for="continuousMode">é€£ç¶šãƒ¢ãƒ¼ãƒ‰</label>
      <input type="checkbox" id="continuousMode">
    </div>
    <div class="option-row">
      <label for="abacusMode">æ®‹åƒãƒˆãƒ¬(ãã‚ã°ã‚“)ãƒ¢ãƒ¼ãƒ‰</label>
      <input type="checkbox" id="abacusMode">
    </div>

    <div>
      <label>æ¡æ•°ã®é¸æŠ</label>
      <div class="grid-select full-width" id="digitGrid">
        <button data-value="1" class="selected">1æ¡</button>
        <button data-value="2">2æ¡</button>
        <button data-value="3">3æ¡</button>
        <button data-value="4">4æ¡</button>
        <button data-value="5">5æ¡</button>
      </div>
    </div>
    <div>
      <label>å‡ºé¡Œæ•°ã®é¸æŠ</label>
      <div class="grid-select" id="questionGrid" style="grid-template-columns: repeat(4, 1fr);">
        <button data-value="1">1å•</button>
        <button data-value="2">2å•</button>
        <button data-value="3">3å•</button>
        <button data-value="5" class="selected">5å•</button>
        <button data-value="7">7å•</button>
        <button data-value="10">10å•</button>
        <button data-value="15">15å•</button>
        <button data-value="20">20å•</button>
      </div>
    </div>
    <div>
      <label id="timeLabel">è¡¨ç¤ºæ™‚é–“ã®é¸æŠ (ç§’)</label>
      <div class="grid-select" id="timeGrid" style="grid-template-columns: repeat(4, 1fr);">
        <button data-value="0.3">0.3s</button><button data-value="0.5">0.5s</button>
        <button data-value="1">1s</button><button data-value="2" class="selected">2s</button>
        <button data-value="3">3s</button><button data-value="4">4s</button>
        <button data-value="5">5s</button><button data-value="6">6s</button>
      </div>
    </div>
    <button id="startBtn" class="action-btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <div id="flashSection" class="card">
    <div id="flashDisplay"></div>
    <div id="abacusContainer"></div>
  </div>

  <div id="inputSection" class="card">
    <input type="text" id="answerDisplay" readonly placeholder="ç­”ãˆã‚’å…¥åŠ›">
    <div class="keypad">
      <button class="key">1</button><button class="key">2</button><button class="key">3</button>
      <button class="key">4</button><button class="key">5</button><button class="key">6</button>
      <button class="key">7</button><button class="key">8</button><button class="key">9</button>
      <button class="key" id="clearBtn">C</button><button class="key">0</button><button class="key" id="backBtn">â†</button>
    </div>
    <button id="checkAnswerBtn" class="action-btn">ç­”ãˆåˆã‚ã›</button>
  </div>

  <div id="resultSection" class="card">
    <div id="resultText" style="font-size: 20px; font-weight: bold;"></div>
    <div id="reviewDisplay" class="review-text"></div>
    <button id="retryBtn" class="action-btn">ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
    <button id="quitBtn" class="action-btn quit-btn" style="display:none;">çµ‚äº†ã—ã¦è¨­å®šã¸</button>
  </div>

  <script>
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    function generateRandomNumber(digits) {
      const min = Math.pow(10, digits - 1);
      const max = Math.pow(10, digits) - 1;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // ä¿®æ­£: éŸ³å£°èª­ã¿ä¸Šã’ã‚’PromiseåŒ–ã—ã¦ç¢ºå®Ÿã«é †ç•ªã«å†ç”Ÿã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
    function speakJapanesePromise(text) {
      return new Promise((resolve) => {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel(); // å‰ã®éŸ³å£°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'ja-JP';
          utterance.rate = 1.2;
          utterance.onend = () => resolve();
          utterance.onerror = () => resolve(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ¬¡ã«é€²ã‚€
          window.speechSynthesis.speak(utterance);
        } else {
          resolve();
        }
      });
    }

    function renderAbacus(num) {
      const container = document.getElementById("abacusContainer");
      container.innerHTML = "";
      const maxDigits = selectedDigitCount + 2;
      const strNum = num.toString().padStart(maxDigits, '0');
      
      [...strNum].reverse().forEach((digit) => {
        const val = parseInt(digit);
        const column = document.createElement("div");
        column.className = "abacus-column";
        
        const upperArea = document.createElement("div");
        upperArea.className = "upper-area";
        const fiveBead = document.createElement("div");
        fiveBead.className = "abacus-bead five-bead" + (val >= 5 ? " active" : "");
        fiveBead.style.transform = val >= 5 ? "translateY(11px)" : "translateY(0px)";
        upperArea.appendChild(fiveBead);
        column.appendChild(upperArea);
        
        const divider = document.createElement("div");
        divider.className = "abacus-divider";
        column.appendChild(divider);
        
        const lowerArea = document.createElement("div");
        lowerArea.className = "lower-area";
        const lowerVal = val % 5;
        for (let i = 1; i <= 4; i++) {
          const bead = document.createElement("div");
          bead.className = "abacus-bead one-bead" + (i <= lowerVal ? " active" : "");
          let offset = (i <= lowerVal) ? -( (4 - lowerVal) * 2 + 15 ) : 0;
          bead.style.transform = `translateY(${offset}px)`;
          lowerArea.appendChild(bead);
        }
        column.appendChild(lowerArea);
        container.appendChild(column);
      });
    }

    let selectedMode = 'flash';
    let selectedDigitCount = 1;
    let selectedQuestionCount = 5;
    let selectedDisplayTime = 2;
    let numbersArray = [];
    let answerSum = 0;
    let history = JSON.parse(localStorage.getItem('flash_math_history') || '[]');

    function updateStatsDisplay() {
      const best = localStorage.getItem('flash_math_best') || 0;
      const recent = history.slice(-10);
      const rate = recent.length ? Math.round((recent.filter(x => x === true).length / recent.length) * 100) : 0;
      document.getElementById("statsDisplay").textContent = `æœ€é«˜ã‚¹ã‚³ã‚¢: ${best} | ç›´è¿‘æ­£ç­”ç‡: ${rate}%`;
    }
    updateStatsDisplay();

    const setupGrid = (gridId, callback) => {
      const grid = document.getElementById(gridId);
      grid.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          grid.querySelectorAll("button").forEach(el => el.classList.remove("selected"));
          btn.classList.add("selected");
          callback(btn.getAttribute("data-value"));
        });
      });
    };

    setupGrid("modeGrid", val => {
      selectedMode = val;
      document.getElementById("timeLabel").textContent = val === 'flash' ? "è¡¨ç¤ºæ™‚é–“ã®é¸æŠ (ç§’)" : "èª­ã¿ä¸Šã’æ™‚é–“ã®é¸æŠ (ç§’)";
    });
    setupGrid("digitGrid", val => selectedDigitCount = parseInt(val));
    setupGrid("questionGrid", val => selectedQuestionCount = parseInt(val));
    setupGrid("timeGrid", val => selectedDisplayTime = parseFloat(val));

    document.getElementById("startBtn").addEventListener("click", startGame);

    async function startGame() {
      const isAbacusMode = document.getElementById("abacusMode").checked;
      document.getElementById("settings").style.display = "none";
      document.getElementById("resultSection").style.display = "none";
      document.getElementById("inputSection").style.display = "none";
      document.getElementById("quitBtn").style.display = document.getElementById("continuousMode").checked ? "block" : "none";
      
      numbersArray = [];
      answerSum = 0;
      for (let i = 0; i < selectedQuestionCount; i++) {
        const num = generateRandomNumber(selectedDigitCount);
        numbersArray.push(num);
        answerSum += num;
      }
      
      const flashSection = document.getElementById("flashSection");
      flashSection.style.display = "flex";
      const display = document.getElementById("flashDisplay");
      const abacusContainer = document.getElementById("abacusContainer");
      
      abacusContainer.style.display = isAbacusMode ? "flex" : "none";
      if(isAbacusMode) renderAbacus(0);

      display.style.opacity = 1;
      for(let i=3; i>0; i--) {
        display.textContent = i;
        await sleep(600);
      }
      display.textContent = "Go!";
      await sleep(400);

      if (selectedMode === 'flash') {
        await flashNumbers(isAbacusMode);
      } else {
        await readNumbers(isAbacusMode);
      }
      
      flashSection.style.display = "none";
      document.getElementById("inputSection").style.display = "flex";
      document.getElementById("answerDisplay").value = "";
    }

    async function flashNumbers(isAbacusMode) {
      const display = document.getElementById("flashDisplay");
      const totalTimeMs = selectedDisplayTime * 1000;
      let fadeDuration = Math.min(200, totalTimeMs / 3);
      const visibleTime = totalTimeMs - (fadeDuration * 2);
      
      let currentTotal = 0;
      for (let num of numbersArray) {
        currentTotal += num;
        display.textContent = num;
        if(isAbacusMode) renderAbacus(currentTotal);
        
        display.style.transition = `opacity ${fadeDuration}ms ease-in`;
        display.style.opacity = 1;
        await sleep(fadeDuration + visibleTime);
        display.style.transition = `opacity ${fadeDuration}ms ease-out`;
        display.style.opacity = 0;
        await sleep(fadeDuration + 100);
      }
    }

    // ä¿®æ­£: èª­ã¿ä¸Šã’ãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰å¾…æ©Ÿæ™‚é–“ã‚’æŒŸã‚€ã‚ˆã†ã«å¤‰æ›´
    async function readNumbers(isAbacusMode) {
      let currentTotal = 0;
      for (let num of numbersArray) {
        currentTotal += num;
        if(isAbacusMode) renderAbacus(currentTotal);
        // æ•°å­—ã‚’èª­ã¿ä¸Šã’ã€çµ‚ã‚ã‚‹ã¾ã§å¾…æ©Ÿ
        await speakJapanesePromise(num.toString());
        // è¨­å®šã•ã‚ŒãŸç§’æ•°åˆ†ã€æ¬¡ã®æ•°å­—ã¾ã§é–“éš”ã‚’ç©ºã‘ã‚‹
        await sleep(selectedDisplayTime * 1000);
      }
    }

    document.querySelectorAll(".keypad .key").forEach(btn => {
      btn.onclick = () => {
        const display = document.getElementById("answerDisplay");
        if (btn.id === "clearBtn") display.value = "";
        else if (btn.id === "backBtn") display.value = display.value.slice(0, -1);
        else display.value += btn.textContent;
      };
    });

    document.getElementById("checkAnswerBtn").onclick = async () => {
      const userAnswer = parseInt(document.getElementById("answerDisplay").value);
      const isCorrect = (userAnswer === answerSum);
      history.push(isCorrect);
      if(history.length > 50) history.shift();
      localStorage.setItem('flash_math_history', JSON.stringify(history));

      if(isCorrect) {
        const score = Math.round((selectedDigitCount * selectedQuestionCount) / selectedDisplayTime * 10);
        const currentBest = parseInt(localStorage.getItem('flash_math_best') || 0);
        if(score > currentBest) localStorage.setItem('flash_math_best', score);
        if(document.getElementById("autoLevel").checked) {
          selectedDisplayTime = Math.max(0.1, Math.round((selectedDisplayTime - 0.1) * 10) / 10);
        }
      } else {
        if(document.getElementById("autoLevel").checked) {
          selectedDisplayTime = Math.round((selectedDisplayTime + 0.1) * 10) / 10;
        }
      }
      updateStatsDisplay();

      document.getElementById("inputSection").style.display = "none";
      const resultSection = document.getElementById("resultSection");
      resultSection.style.display = "block";
      document.getElementById("resultText").textContent = isCorrect ? "æ­£è§£ï¼ğŸ‰" : "ä¸æ­£è§£...ğŸ˜¢";
      document.getElementById("resultText").style.color = isCorrect ? "#2ecc71" : "#e74c3c";
      document.getElementById("reviewDisplay").textContent = isCorrect ? "" : `å¼: ${numbersArray.join(' + ')} = ${answerSum}`;

      if(document.getElementById("continuousMode").checked) {
        await sleep(2000);
        if(resultSection.style.display !== "none") startGame(); 
      }
    };

    document.getElementById("retryBtn").onclick = () => {
      document.getElementById("settings").style.display = "block";
      document.getElementById("resultSection").style.display = "none";
    };

    document.getElementById("quitBtn").onclick = () => {
      document.getElementById("settings").style.display = "block";
      document.getElementById("resultSection").style.display = "none";
    };
  </script>
</body>
</html>
