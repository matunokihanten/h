<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>積み木数えゲーム - More Fun!</title>
  <style>
    /* シンプルな白背景・最小限のスタイル */
    html, body {
      margin: 0;
      overflow: hidden;
      background-color: #ffffff;
      font-family: Arial, sans-serif;
    }
    /* UI部分：上部中央に固定 */
    #ui {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      z-index: 10;
    }
    #ui h1 {
      margin: 0;
      font-size: 1.8em;
      color: #333;
    }
    #ui p, #ui input, #ui button {
      font-size: 1em;
      color: #333;
      margin: 5px;
    }
    #result {
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
    #score {
      font-size: 1.2em;
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
    /* レンダラーのキャンバスは中央表示 */
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <!-- Three.js の読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
  <div id="ui">
    <h1>積み木数えゲーム</h1>
    <p>3Dの積み木（黒い縁取り付き）が回転しながら現れます。<br>
       総数を入力して、正解を目指しましょう！</p>
    <input type="number" id="answer" placeholder="積み木の数を入力">
    <button id="submitBtn">答える</button>
    <p id="result"></p>
    <p id="score">Score: 0</p>
  </div>
  <div id="gameContainer"></div>
  
  <script>
    // グローバル変数
    let scene, camera, renderer;
    let blocks = [];
    let blockCount;
    let score = 0;

    // ゲーム初期化関数
    function initGame() {
      const container = document.getElementById("gameContainer");
      
      // シーン作成（背景は白）
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);
      
      // カメラ設定
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 5, 10);
      camera.lookAt(0, 0, 0);
      
      // レンダラー設定（抗エイリアス有効、影も有効）
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      container.innerHTML = "";
      container.appendChild(renderer.domElement);
      
      // 照明の追加（方向光）
      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(3, 10, 3);
      light.castShadow = true;
      scene.add(light);
      
      // 積み木生成
      generateBlocks();
      
      window.addEventListener("resize", onWindowResize, false);
      animate();
    }

    // 積み木生成関数（積み木数は3〜100個のランダム値）
    function generateBlocks() {
      // 既存のブロックをシーンから削除
      blocks.forEach(block => scene.remove(block));
      blocks = [];
      
      // ランダムな積み木の数（3〜100）
      blockCount = Math.floor(Math.random() * (100 - 3 + 1)) + 3;
      
      for (let i = 0; i < blockCount; i++) {
        // 立方体ジオメトリ（サイズ0.5×0.5×0.5）
        const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
        // 材質は木目調の茶色
        const material = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
        const cube = new THREE.Mesh(geometry, material);
        
        // 新規生成時は小さくしておき、後で拡大する演出を追加
        cube.scale.set(0.1, 0.1, 0.1);
        
        // ランダムな位置に配置（画面中央付近に散らばる）
        cube.position.set(
          Math.random() * 4 - 2,
          Math.random() * 4,
          Math.random() * 4 - 2
        );
        cube.castShadow = true;
        scene.add(cube);
        
        // 黒い縁取り：EdgesGeometry により全エッジを抽出し、LineSegments で描画
        const edges = new THREE.EdgesGeometry(geometry);
        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x000000 });
        const edgeLines = new THREE.LineSegments(edges, lineMaterial);
        cube.add(edgeLines);
        
        blocks.push(cube);
      }
    }

    // アニメーションループ
    function animate() {
      requestAnimationFrame(animate);
      
      // 各ブロックにゆっくりと回転させ、スケールアップ演出を追加
      blocks.forEach(cube => {
        cube.rotation.x += 0.005;
        cube.rotation.y += 0.005;
        // 生成時は小さいサイズから本来のサイズ（1,1,1）に段階的に拡大
        if (cube.scale.x < 1) {
          cube.scale.x += 0.05;
          cube.scale.y += 0.05;
          cube.scale.z += 0.05;
          if (cube.scale.x > 1) cube.scale.set(1, 1, 1);
        }
      });
      
      renderer.render(scene, camera);
    }

    // ウィンドウリサイズ対応
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // ユーザー回答の判定処理
    document.getElementById("submitBtn").addEventListener("click", () => {
      const userAnswer = parseInt(document.getElementById("answer").value, 10);
      const resultParagraph = document.getElementById("result");
      const scoreParagraph = document.getElementById("score");

      if (userAnswer === blockCount) {
        resultParagraph.textContent = "正解！次の問題へ...";
        score++;
        scoreParagraph.textContent = "Score: " + score;
        setTimeout(() => {
          resultParagraph.textContent = "";
          generateBlocks(); // 新たな問題を出題
          document.getElementById("answer").value = "";
        }, 1500);
      } else {
        resultParagraph.textContent = "違うよ！正解は " + blockCount + " 個でした。次の問題へ...";
        setTimeout(() => {
          resultParagraph.textContent = "";
          generateBlocks(); // 新たな問題を出題
          document.getElementById("answer").value = "";
        }, 1500);
      }
    });

    // ゲームの初期化実行
    initGame();
  </script>
</body>
</html>