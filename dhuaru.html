<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>デュアルNバック トレーニングDX（色対応）</title>
<style>
/* シンプルなデザインに軽量化 */
body { font-family: sans-serif; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0; background-color:#f0f2f5;color:#333;text-align:center;}
.container {width:90%;max-width:450px;padding:20px;background-color:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
h2 {color:#1a237e;}
p {margin-bottom:20px;line-height:1.6;}
.settings {display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:15px;margin-bottom:20px;}
.settings select,.settings button {padding:8px 12px;border-radius:5px;border:1px solid #ccc;font-size:16px;}
.radio-group {display:flex;align-items:center;gap:5px;font-size:14px;}
#start-btn,#end-btn {background-color:#4caf50;color:white;border:none;cursor:pointer;}
#start-btn:hover,#end-btn:hover {opacity:0.8;}
#end-btn {background-color:#f44336;display:none;}
.progress-container {width:100%;background-color:#e0e0e0;border-radius:5px;margin-bottom:15px;}
#progress-bar {height:8px;background-color:#3f51b5;border-radius:5px;width:0;}
#game-board {display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:8px;width:280px;height:280px;margin:20px auto;border:2px solid #ccc;padding:8px;border-radius:8px;background-color:#e8eaf6;}
.grid-cell {display:flex;justify-content:center;align-items:center;border-radius:5px;font-size:2rem;font-weight:bold;color:#333;}
.grid-cell.active {color:white;}
#status-bar {margin:10px 0;font-size:16px;min-height:20px;}
#high-score {font-size:12px;color:#888;}
#controls {display:flex;justify-content:space-around;margin-top:20px;gap:10px;}
.match-btn {flex:1;padding:10px;font-size:14px;font-weight:bold;border-radius:5px;border:2px solid;cursor:pointer;background-color:#fff;}
#visual-match-btn {border-color:#2196f3;color:#2196f3;}
#audio-match-btn {border-color:#f44336;color:#f44336;}
#color-match-btn {border-color:#4caf50;color:#4caf50;}
.match-btn:disabled {opacity:0.5;cursor:not-allowed;}
#feedback-container {min-height:40px;margin-top:10px;font-weight:bold;}
.feedback-item {padding:2px 8px;border-radius:5px;margin-top:4px;}
.feedback-item.correct {color:white;background-color:#4caf50;}
.feedback-item.incorrect {color:white;background-color:#f44336;}
.feedback-text {font-size:14px;color:#333;margin-top:4px;}
#response-time {font-size:12px;color:#666;}
</style>
</head>
<body>
<div class="container" id="main-container">
<h2>🧠 デュアルNバック トレーニングDX（色対応）</h2>
<p>位置・音声・色のいずれか1つがN回前と同じかを判断します。</p>
<div class="settings">
<label for="n-level">Nレベル:</label>
<select id="n-level">
<option value="1">1-Back</option>
<option value="2" selected>2-Back</option>
<option value="3">3-Back</option>
<option value="4">4-Back</option>
<option value="5">5-Back</option>
</select>
<div class="radio-group">
<label>文字表示:</label>
<input type="radio" id="show-letter-yes" name="show-letter" value="true">
<label for="show-letter-yes">はい</label>
<input type="radio" id="show-letter-no" name="show-letter" value="false" checked>
<label for="show-letter-no">いいえ</label>
</div>
<button id="start-btn">スタート</button>
<button id="end-btn">終了</button>
</div>
<div id="high-score">ハイスコア: N/A</div>
<div id="status-bar">Nレベルを選択してスタートしてください</div>
<div class="progress-container"><div id="progress-bar"></div></div>
<div id="game-board"></div>
<div id="controls">
<button id="visual-match-btn" class="match-btn" disabled>位置一致</button>
<button id="audio-match-btn" class="match-btn" disabled>音声一致</button>
<button id="color-match-btn" class="match-btn" disabled>色一致</button>
</div>
<div id="feedback-container"></div>
</div>
<script>
const GRID_SIZE = 9;
const LETTERS = ['C', 'H', 'K', 'L', 'Q', 'R', 'S', 'T'];
const COLORS = ['red', 'green', 'blue', 'orange', 'purple', 'pink', 'yellow', 'brown', 'cyan'];
const STIMULUS_INTERVAL = 3000;
const TOTAL_TRIALS_BASE = 20;
let nLevel = 2, totalTrials = 0, currentTrial = 0;
let visualScore = 0, audioScore = 0, colorScore = 0;
let stimuliHistory = [];
let userResponses = {visual: null, audio: null, color: null};
let gameInterval = null, isGameRunning = false, trialStartTime = 0;

const mainContainer = document.getElementById('main-container');
const startBtn = document.getElementById('start-btn');
const endBtn = document.getElementById('end-btn');
const nLevelSelect = document.getElementById('n-level');
const showLetterRadios = document.getElementsByName('show-letter');
const gameBoard = document.getElementById('game-board');
const visualMatchBtn = document.getElementById('visual-match-btn');
const audioMatchBtn = document.getElementById('audio-match-btn');
const colorMatchBtn = document.getElementById('color-match-btn');
const statusBar = document.getElementById('status-bar');
const feedbackContainer = document.getElementById('feedback-container');
const progressBar = document.getElementById('progress-bar');
const highScoreElem = document.getElementById('high-score');

function init() {
    createGameBoard();
    setupEventListeners();
    updateHighScoreDisplay();
    updateStatusBar();
}
function createGameBoard() {
    gameBoard.innerHTML = '';
    for (let i = 0; i < GRID_SIZE; i++) {
        const cell = document.createElement('div');
        cell.classList.add('grid-cell');
        cell.id = `cell-${i}`;
        gameBoard.appendChild(cell);
    }
}
function setupEventListeners() {
    startBtn.addEventListener('click', startGame);
    endBtn.addEventListener('click', endGame);
    visualMatchBtn.addEventListener('click', () => recordResponse('visual'));
    audioMatchBtn.addEventListener('click', () => recordResponse('audio'));
    colorMatchBtn.addEventListener('click', () => recordResponse('color'));
    nLevelSelect.addEventListener('change', updateHighScoreDisplay);
}
function updateHighScoreDisplay() {
    const currentN = parseInt(nLevelSelect.value);
    const score = localStorage.getItem(`highScore-N${currentN}`);
    highScoreElem.textContent = score ? `N=${currentN} ハイスコア: ${score}点` : `N=${currentN} ハイスコア: N/A`;
}
function startGame() {
    if (isGameRunning) return;
    isGameRunning = true;
    mainContainer.classList.add('game-active');
    nLevel = parseInt(nLevelSelect.value);
    totalTrials = TOTAL_TRIALS_BASE + nLevel;
    currentTrial = 0;
    visualScore = audioScore = colorScore = 0;
    stimuliHistory = [];
    startBtn.style.display = 'none';
    endBtn.style.display = 'inline-block';
    nLevelSelect.disabled = true;
    for (const radio of showLetterRadios) {
        radio.disabled = true;
    }
    visualMatchBtn.disabled = false;
    audioMatchBtn.disabled = false;
    colorMatchBtn.disabled = false;
    feedbackContainer.innerHTML = '';
    
    runTrial();
    gameInterval = setInterval(runTrial, STIMULUS_INTERVAL);
}
function runTrial() {
    if (currentTrial > nLevel) {
        evaluateUnansweredResponses();
    }
    
    if (currentTrial >= totalTrials) {
        endGame();
        return;
    }
    
    currentTrial++;
    resetUserResponses();

    let position, letter, color;
    if (currentTrial > nLevel) {
        const matchType = ['visual', 'audio', 'color'][Math.floor(Math.random() * 3)];
        const prev = stimuliHistory[currentTrial - 1 - nLevel];
        
        position = (matchType === 'visual') ? prev.position : getDifferentValue(prev.position, GRID_SIZE);
        letter = (matchType === 'audio') ? prev.letter : getDifferentValue(prev.letter, LETTERS);
        color = (matchType === 'color') ? prev.color : getDifferentValue(prev.color, COLORS);
    } else {
        position = Math.floor(Math.random() * GRID_SIZE);
        letter = LETTERS[Math.floor(Math.random() * LETTERS.length)];
        color = COLORS[Math.floor(Math.random() * COLORS.length)];
    }
    stimuliHistory.push({position, letter, color});
    presentStimulus(position, letter, color);
    updateStatusBar();
    updateProgressBar();
    trialStartTime = Date.now();
}
function getDifferentValue(current, arrOrLen) {
    if (typeof arrOrLen === 'number') {
        let v;
        do { v = Math.floor(Math.random() * arrOrLen); } while (v === current);
        return v;
    } else {
        let v;
        do { v = arrOrLen[Math.floor(Math.random() * arrOrLen.length)]; } while (v === current);
        return v;
    }
}
function presentStimulus(position, letter, color) {
    document.querySelectorAll('.grid-cell').forEach(c => {
        c.classList.remove('active');
        c.style.backgroundColor = 'white';
        c.textContent = '';
    });
    const active = document.getElementById(`cell-${position}`);
    if (active) {
        active.classList.add('active');
        active.style.backgroundColor = color;
        const showLetter = document.querySelector('input[name="show-letter"]:checked').value === 'true';
        if (showLetter) {
            active.textContent = letter;
        }
    }
    if ('speechSynthesis' in window && typeof SpeechSynthesisUtterance !== 'undefined') {
        speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(letter);
        utter.lang = 'en-US';
        utter.rate = 0.9;
        speechSynthesis.speak(utter);
    }
}
function recordResponse(type) {
    if (!isGameRunning || userResponses[type] !== null || currentTrial <= nLevel) return;
    
    userResponses[type] = true;
    
    const cur = stimuliHistory[currentTrial - 1];
    const prev = stimuliHistory[currentTrial - 1 - nLevel];
    if (!cur || !prev) return;
    
    let isMatch, typeName, correctText;
    
    if(type === 'visual') {
        isMatch = cur.position === prev.position;
        typeName = '位置';
    } else if (type === 'audio') {
        isMatch = cur.letter === prev.letter;
        typeName = '音声';
    } else if (type === 'color') {
        isMatch = cur.color === prev.color;
        typeName = '色';
    }
    
    const isCorrect = isMatch; // ユーザーは一致ボタンを押しているので、一致していれば正解
    correctText = isCorrect ? '一致' : '不一致';

    let feedbackText;
    if (isCorrect) {
        feedbackText = `✅ ${typeName} 正解！`;
        if (type === 'visual') visualScore++;
        else if (type === 'audio') audioScore++;
        else if (type === 'color') colorScore++;
    } else {
        feedbackText = `❌ ${typeName} 不正解 | 正解は "${correctText}" でした。`;
    }
    
    showFeedback(feedbackText, isCorrect ? 'correct' : 'incorrect');
    
    const btnMap = {visual: visualMatchBtn, audio: audioMatchBtn, color: colorMatchBtn};
    btnMap[type].classList.add('responded');
    btnMap[type].disabled = true;
    
    updateStatusBar();
}

function evaluateUnansweredResponses() {
    if (currentTrial - 1 < nLevel) return;
    
    const cur = stimuliHistory[currentTrial - 2];
    const prev = stimuliHistory[currentTrial - 2 - nLevel];
    if (!cur || !prev) return;
    
    const isVisualMatch = cur.position === prev.position;
    const isAudioMatch = cur.letter === prev.letter;
    const isColorMatch = cur.color === prev.color;
    
    if (userResponses.visual === null) {
        if (!isVisualMatch) {
            visualScore++;
        } else {
            showFeedback(`❌ 位置 不正解 | 正解は "一致" でした。`, 'incorrect');
        }
    }
    if (userResponses.audio === null) {
        if (!isAudioMatch) {
            audioScore++;
        } else {
            showFeedback(`❌ 音声 不正解 | 正解は "一致" でした。`, 'incorrect');
        }
    }
    if (userResponses.color === null) {
        if (!isColorMatch) {
            colorScore++;
        } else {
            showFeedback(`❌ 色 不正解 | 正解は "一致" でした。`, 'incorrect');
        }
    }
    
    updateStatusBar();
}

function resetUserResponses() {
    userResponses = {visual: null, audio: null, color: null};
    [visualMatchBtn, audioMatchBtn, colorMatchBtn].forEach(btn => {
        btn.classList.remove('responded');
        btn.disabled = false;
    });
    feedbackContainer.innerHTML = '';
}

function showFeedback(text, className) {
    const span = document.createElement('span');
    span.classList.add('feedback-item', className);
    span.textContent = text;
    feedbackContainer.prepend(span);
}
function endGame() {
    clearInterval(gameInterval);
    isGameRunning = false;
    mainContainer.classList.remove('game-active');
    startBtn.style.display = 'inline-block';
    endBtn.style.display = 'none';
    nLevelSelect.disabled = false;
    for (const radio of showLetterRadios) {
        radio.disabled = false;
    }
    [visualMatchBtn, audioMatchBtn, colorMatchBtn].forEach(btn => {
        btn.disabled = true;
        btn.classList.remove('responded');
    });
    document.querySelectorAll('.grid-cell').forEach(cell => {
        cell.classList.remove('active');
        cell.style.backgroundColor = 'white';
        cell.textContent = '';
    });
    
    evaluateUnansweredResponses();
    
    const totalScore = visualScore + audioScore + colorScore;
    const totalPossibleScore = (totalTrials - nLevel) * 3;
    const accuracy = totalPossibleScore > 0 ? ((totalScore / totalPossibleScore) * 100).toFixed(1) : 0;
    statusBar.textContent = `ゲーム終了！スコア: ${totalScore} / ${totalPossibleScore}、正答率: ${accuracy}%`;
    saveHighScore(totalScore);
    updateHighScoreDisplay();
    progressBar.style.width = '0';
}
function saveHighScore(newScore) {
    const currentN = parseInt(nLevelSelect.value);
    const stored = localStorage.getItem(`highScore-N${currentN}`);
    if (!stored || newScore > parseInt(stored)) {
        localStorage.setItem(`highScore-N${currentN}`, newScore);
    }
}
function updateStatusBar() {
    const totalScoreableTrials = totalTrials - nLevel;
    const scoreableTrial = currentTrial > nLevel ? currentTrial - nLevel : 0;
    const totalScore = visualScore + audioScore + colorScore;
    statusBar.textContent = `N=${nLevel} | 試行: ${scoreableTrial} / ${totalScoreableTrials} | スコア: ${totalScore}`;
}
function updateProgressBar() {
    const progress = (currentTrial / totalTrials) * 100;
    progressBar.style.width = `${progress}%`;
}
init();
</script>
</body>
</html>
