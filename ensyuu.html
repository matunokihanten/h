<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- ズーム操作の誤作動防止 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>円周率暗記ゲーム - クールなデザイン</title>
  <!-- Google Fonts: Roboto Mono -->
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,700&display=swap" rel="stylesheet">
  <style>
    /* 背景はグラデーション、全体的にダークな雰囲気 */
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #000, #434343);
      color: #fff;
      font-family: 'Roboto Mono', monospace;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    /* ゲームコンテナ：半透明の黒背景・角丸・影 */
    #gameContainer {
      max-width: 600px;
      margin: 40px auto;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    h1 {
      font-size: 2em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
    }
    .config, #controlButtons {
      margin: 15px 0;
    }
    label {
      font-size: 16px;
    }
    input[type="number"] {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
      width: 80px;
      text-align: center;
    }
    input[type="radio"] {
      transform: scale(1.3);
      margin: 0 5px;
    }
    /* 入力済み数字の表示エリア。背景に半透明エフェクト。高さ固定で内容が溢れたらスクロール */
    #piDisplay {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      min-height: 100px;   /* 最低の高さ */
      max-height: 150px;   /* 上限の高さ */
      overflow-y: auto;    /* 内容が溢れた場合は縦スクロール */
      line-height: 1.2;
      letter-spacing: 1px;
      margin: 20px 0;
    }
    .digit {
      font-size: 16px;
    }
    .wrong {
      color: #ff4d4d;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
    }
    /* 電卓型キーパッド */
    #keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-width: 400px;
      margin: 0 auto 20px auto;
    }
    #keypad button {
      padding: 20px;
      font-size: 24px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      background: linear-gradient(45deg, #0066ff, #00ccff);
      color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      transition: transform 0.1s ease;
      touch-action: manipulation; /* タッチ操作の反応向上 */
    }
    #keypad button:hover {
      background: linear-gradient(45deg, #0055ee, #00bbee);
    }
    #keypad button:active {
      transform: scale(0.95);
    }
    /* スタート、終了ボタン */
    #controlButtons button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(45deg, #28a745, #218838);
      color: #fff;
      cursor: pointer;
      margin: 0 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      transition: background 0.2s ease;
    }
    #controlButtons button:hover {
      background: linear-gradient(45deg, #218838, #1e7e34);
    }
    #controlButtons button:active {
      transform: scale(0.98);
    }
    #timerDiv {
      font-size: 20px;
      margin: 10px;
    }
    #message {
      margin: 10px;
      font-size: 16px;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <h1>円周率暗記ゲーム</h1>
    <div class="config">
      <label for="startIndex">開始桁数:</label>
      <input type="number" id="startIndex" value="0" min="0">
    </div>
    <div class="config">
      <label for="targetDigits">目標桁数 (最大500):</label>
      <input type="number" id="targetDigits" value="500" min="1" max="500">
    </div>
    <div class="config">
      <input type="radio" id="modeStandard" name="mode" value="standard" checked>
      <label for="modeStandard">標準モード</label>
      &nbsp;&nbsp;
      <input type="radio" id="modeTimeAttack" name="mode" value="timeAttack">
      <label for="modeTimeAttack">タイムアタックモード</label>
      &nbsp;&nbsp;
      <input type="radio" id="modePuzzle" name="mode" value="puzzle">
      <label for="modePuzzle">パズル＆補完モード</label>
    </div>
    <div id="controlButtons" class="config">
      <button id="startBtn">スタート</button>
      <button id="exitBtn">終了</button>
    </div>
    <div id="timerDiv" style="display:none;">タイム: 0秒</div>
    <div id="piDisplay"></div>
    <div id="message"></div>
    <!-- 電卓型キーパッド（上から 7,8,9 / 4,5,6 / 1,2,3 / .,0,C） -->
    <div id="keypad">
      <button class="key">7</button>
      <button class="key">8</button>
      <button class="key">9</button>
      <button class="key">4</button>
      <button class="key">5</button>
      <button class="key">6</button>
      <button class="key">1</button>
      <button class="key">2</button>
      <button class="key">3</button>
      <button class="key">.</button>
      <button class="key">0</button>
      <button class="key" id="clearButton">C</button>
    </div>
  </div>
  
  <script>
    // ダブルクリックによるズーム拡大防止
    document.addEventListener('dblclick', function(e) {
      e.preventDefault();
    }, { passive: false });
    
    document.addEventListener("DOMContentLoaded", function() {
      // π の数字（小数点含む、約500桁以上）
      const pi =
        "3.14159265358979323846264338327950288419716939937510" +
        "58209749445923078164062862089986280348253421170679" +
        "82148086513282306647093844609550582231725359408128" +
        "48111745028410270193852110555964462294895493038196" +
        "44288109756659334461284756482337867831652712019091" +
        "45648566923460348610454326648213393607260249141273" +
        "72458700660631558817488152092096282925409171536436" +
        "78925903600113305305488204665213841469519415116094" +
        "33057270365759591953092186117381932611793105118548";
      
      // モード別で利用する共通変数
      let targetCount = 0;
      let startIndex = 0;
      // 標準／タイムアタック向け
      let currentIndex = 0;
      let digitsHistory = [];
      // パズルモード向け（配列、欠落位置リスト、入力位置ポインタ）
      let puzzle = [];
      let missingIndices = [];
      let missingPointer = 0;
      
      let gameMode = "standard";  // "standard", "timeAttack", "puzzle"
      let timerInterval = null;
      let startTime = null;
      let gameActive = false;
      
      const startIndexInput = document.getElementById("startIndex");
      const targetDigitsInput = document.getElementById("targetDigits");
      const modeStandardRadio = document.getElementById("modeStandard");
      const modeTimeAttackRadio = document.getElementById("modeTimeAttack");
      const modePuzzleRadio = document.getElementById("modePuzzle");
      const startBtn = document.getElementById("startBtn");
      const exitBtn = document.getElementById("exitBtn");
      const piDisplay = document.getElementById("piDisplay");
      const messageDiv = document.getElementById("message");
      const keypadButtons = document.querySelectorAll(".key");
      const timerDiv = document.getElementById("timerDiv");
      
      // ゲーム初期化：モードに応じて処理を分岐
      function initGame() {
        // 共通設定
        startIndex = parseInt(startIndexInput.value, 10);
        if (isNaN(startIndex) || startIndex < 0) {
          startIndex = 0;
          startIndexInput.value = 0;
        }
        targetCount = parseInt(targetDigitsInput.value, 10);
        if (isNaN(targetCount) || targetCount < 1) {
          targetCount = 500;
          targetDigitsInput.value = 500;
        }
        if (startIndex + targetCount > pi.length) {
          targetCount = pi.length - startIndex;
          targetDigitsInput.value = targetCount;
        }
        
        // 判定するモードを設定
        if (modePuzzleRadio.checked) {
          gameMode = "puzzle";
          timerDiv.style.display = "none";
          initPuzzleMode();
        } else {
          // 標準・タイムアタック共通の処理
          gameMode = modeTimeAttackRadio.checked ? "timeAttack" : "standard";
          currentIndex = startIndex;
          digitsHistory = [];
          piDisplay.innerHTML = "";
          messageDiv.textContent = "";
          gameActive = true;
          if (gameMode === "timeAttack") {
            timerDiv.style.display = "block";
            startTimer();
          } else {
            timerDiv.style.display = "none";
            stopTimer();
          }
        }
      }
      
      // パズル＆補完モードの初期化
      function initPuzzleMode() {
        gameActive = true;
        // puzzle 配列を初期化。各セルは正解の数字と入力状態を持つ
        puzzle = [];
        for (let i = 0; i < targetCount; i++) {
          puzzle.push({
            correct: pi.charAt(startIndex + i),
            prefilled: false,
            userInput: null,
            wrong: false
          });
        }
        // 例として全体の40%をランダムにプレフィル
        const prefillProbability = 0.4;
        for (let i = 0; i < targetCount; i++) {
          if (Math.random() < prefillProbability) {
            puzzle[i].prefilled = true;
          }
        }
        // 少なくとも１つは入力させる（全てプレフィルになったら、先頭を未入力に修正）
        missingIndices = [];
        for (let i = 0; i < targetCount; i++) {
          if (!puzzle[i].prefilled) {
            missingIndices.push(i);
          }
        }
        if (missingIndices.length === 0) {
          puzzle[0].prefilled = false;
          missingIndices.push(0);
        }
        missingPointer = 0;
        piDisplay.innerHTML = "";
        messageDiv.textContent = "";
        updatePuzzleDisplay();
      }
      
      // タイマー開始（タイムアタックモード向け）
      function startTimer() {
        startTime = Date.now();
        timerDiv.textContent = "タイム: 0秒";
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          timerDiv.textContent = "タイム: " + elapsed + "秒";
        }, 500);
      }
      
      // タイマー停止
      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
      
      // 標準・タイムアタックモードの表示更新（20桁ごと）
      function updateStandardDisplay() {
        let lines = [];
        for (let i = 0; i < digitsHistory.length; i += 20) {
          let line = digitsHistory.slice(i, i + 20)
            .map(item => item.wrong ? `<span class="digit wrong">${item.digit}</span>` : `<span class="digit">${item.digit}</span>`)
            .join("");
          lines.push(line);
        }
        piDisplay.innerHTML = lines.join("<br>");
      }
      
      // パズルモードの表示更新
      function updatePuzzleDisplay() {
        let displayStr = "";
        for (let i = 0; i < targetCount; i++) {
          let cell = puzzle[i];
          let charToShow = "";
          if (cell.prefilled) {
            charToShow = cell.correct;
          } else {
            if (cell.userInput !== null) {
              charToShow = cell.userInput;
            } else {
              charToShow = "_";
            }
          }
          if (!cell.prefilled && cell.userInput !== null && cell.wrong) {
            displayStr += `<span class="digit wrong">${charToShow}</span>`;
          } else {
            displayStr += `<span class="digit">${charToShow}</span>`;
          }
          if ((i + 1) % 20 === 0) {
            displayStr += "<br>";
          }
        }
        piDisplay.innerHTML = displayStr;
      }
      
      // キー入力の処理（モード別）
      function handleKeyInput(value) {
        if (!gameActive) return;
        
        // 共通の削除処理
        if (value === "C") {
          if (gameMode === "puzzle") {
            if (missingPointer > 0) {
              missingPointer--;
              const indexToClear = missingIndices[missingPointer];
              puzzle[indexToClear].userInput = null;
              puzzle[indexToClear].wrong = false;
              updatePuzzleDisplay();
              messageDiv.textContent = "";
            }
          } else {
            if (currentIndex > startIndex) {
              currentIndex--;
              digitsHistory.pop();
              updateStandardDisplay();
              messageDiv.textContent = "";
            }
          }
          return;
        }
        
        // 入力処理
        if (gameMode === "puzzle") {
          if (missingPointer < missingIndices.length) {
            const curMissing = missingIndices[missingPointer];
            const expected = puzzle[curMissing].correct;
            if (value === expected) {
              puzzle[curMissing].userInput = value;
              puzzle[curMissing].wrong = false;
              messageDiv.textContent = "正解！ " + (missingPointer + 1) + " / " + missingIndices.length;
            } else {
              puzzle[curMissing].userInput = value;
              puzzle[curMissing].wrong = true;
              messageDiv.textContent = "間違い！ 正解は '" + expected + "' です";
            }
            missingPointer++;
            updatePuzzleDisplay();
            if (missingPointer === missingIndices.length) {
              messageDiv.textContent += " クリア！ 全て補完しました";
              gameActive = false;
            }
          }
        } else {
          if (currentIndex < startIndex + targetCount) {
            const expected = pi.charAt(currentIndex);
            if (value === expected) {
              digitsHistory.push({ digit: expected, wrong: false });
              messageDiv.textContent = "正解！ 現在 " + (currentIndex - startIndex + 1) + " 桁";
            } else {
              digitsHistory.push({ digit: expected, wrong: true });
              messageDiv.textContent = "間違い！ 正解は '" + expected + "' です";
            }
            currentIndex++;
            updateStandardDisplay();
            if (currentIndex === startIndex + targetCount) {
              messageDiv.textContent += "（目標桁数に達しました）";
              gameActive = false;
              stopTimer();
            }
          }
        }
      }
      
      // キーパッドの各ボタンにクリックと touchstart のイベントを設定
      keypadButtons.forEach(btn => {
        const handler = function(e) {
          e.preventDefault();
          handleKeyInput(this.textContent);
        };
        btn.addEventListener("click", handler);
        btn.addEventListener("touchstart", handler);
      });
      
      startBtn.addEventListener("click", function() {
        stopTimer();
        initGame();
      });
      
      exitBtn.addEventListener("click", function() {
        gameActive = false;
        stopTimer();
        messageDiv.textContent = "ゲーム終了";
      });
    });
  </script>
</body>
</html>