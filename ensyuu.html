<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>円周率暗記ゲーム</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Reset and Base Styles */
    body {
      margin: 0;
      padding: 0;
      background: #121212;
      color: #E0E0E0;
      font-family: 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      padding: 20px;
    }

    #gameContainer {
      width: 100%;
      max-width: 700px;
      background: #1E1E1E;
      border: 1px solid #444;
      padding: 30px;
      box-sizing: border-box;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    /* Headings and Text */
    h2 {
        font-size: 24px;
        color: #fff;
        margin-bottom: 20px;
        text-align: center;
    }

    p, label {
      font-size: 16px;
      line-height: 1.5;
    }

    /* Controls and Configuration */
    .config, .mode-select, #controlButtons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .config-group, .mode-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label {
      font-size: 16px;
      color: #A0A0A0;
    }

    input[type="number"] {
      padding: 8px 12px;
      border: 1px solid #555;
      border-radius: 6px;
      font-size: 16px;
      width: 90px;
      text-align: center;
      background-color: #2D2D2D;
      color: #fff;
      -moz-appearance: textfield;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="radio"] {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border: 1px solid #777;
      border-radius: 50%;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
    }
    input[type="radio"]:checked {
      background-color: #007BFF;
      border-color: #007BFF;
    }
    input[type="radio"]:checked::after {
      content: '';
      display: block;
      width: 8px;
      height: 8px;
      background: #1E1E1E;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Game Display */
    #piDisplay {
      background: #2D2D2D;
      border: 1px solid #444;
      padding: 20px;
      min-height: 130px;
      max-height: 130px;
      overflow-y: hidden;
      letter-spacing: 2px;
      line-height: 1.6;
      margin: 25px auto;
      text-align: left;
      word-break: break-all;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      font-family: 'Roboto Mono', monospace;
      font-size: 20px;
      border-radius: 8px;
      position: relative;
    }

    .digit {
      display: inline-block;
      width: 1ch;
      text-align: center;
    }
    
    .wrong {
      color: #FF4136;
      text-decoration: underline;
    }
    .current {
      background-color: #007BFF;
      color: #fff;
      border-radius: 4px;
      animation: pulse 1.2s infinite ease-in-out;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.8);
    }
    .current-placeholder {
      background-color: #007BFF;
      color: #007BFF;
      border-radius: 4px;
      animation: pulse 1.2s infinite ease-in-out;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.8);
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Buttons */
    button {
      padding: 12px 24px;
      font-size: 16px;
      border: 1px solid #666;
      border-radius: 8px;
      background: #2D2D2D;
      color: #E0E0E0;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      font-family: 'Roboto', sans-serif;
      touch-action: manipulation;
    }
    button:hover {
      background: #444;
      border-color: #999;
      color: #fff;
    }
    button:active {
      transform: translateY(2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #startBtn {
      background: #007BFF;
      border-color: #007BFF;
      color: #fff;
      font-weight: bold;
    }
    #startBtn:hover {
      background: #0056b3;
      border-color: #0056b3;
    }

    #exitBtn, #resetBtn {
        background: #555;
        border-color: #555;
    }

    #exitBtn:hover, #resetBtn:hover {
        background: #666;
        border-color: #777;
    }

    /* Keypad */
    #keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      max-width: 330px;
      margin: 25px auto 0 auto;
    }
    #keypad button {
      padding: 25px;
      font-size: 28px;
      font-weight: bold;
      border-radius: 12px;
      font-family: 'Roboto Mono', monospace;
    }
    #clearButton {
      background: #FF4136;
      border-color: #FF4136;
      color: #fff;
    }
    #clearButton:hover {
      background: #e6392b;
      border-color: #e6392b;
    }

    /* Practice Mode Highlight */
    .practice-highlight {
      background: #FFD700 !important;
      color: #1E1E1E !important;
      border: 1px solid #FFD700 !important;
      animation: none !important;
    }

    /* Ranking Container */
    #rankingContainer {
      margin-top: 30px;
      padding: 25px;
      border: 1px solid #444;
      background: #2D2D2D;
      border-radius: 12px;
    }
    #rankingContainer h3 {
      text-align: center;
      margin-top: 0;
      color: #fff;
      font-size: 20px;
    }
    #rankingList {
      list-style: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    #rankingList li {
      margin-bottom: 10px;
      padding: 12px;
      background: #1E1E1E;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 6px;
    }
    #rankingList li:last-child {
        border-bottom: none;
    }
    #rankingList li .ranking-details {
      font-size: 14px;
      color: #999;
    }
    #clearRankingBtn {
        display: block;
        width: 100%;
        box-sizing: border-box;
    }

    /* Time Mode Info */
    #timeModeInfo {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #444;
      display: none;
    }
    #timeModeInfo p {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
      color: #007BFF;
    }
    #progressContainer {
      width: 100%;
      background-color: #2D2D2D;
      border: 1px solid #444;
      height: 15px;
      margin-top: 15px;
      padding: 2px;
      box-sizing: border-box;
      border-radius: 8px;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: #007BFF;
      border-radius: 6px;
      transition: width 0.1s linear;
    }

    #message {
        text-align: center;
        margin-top: 15px;
        font-size: 16px;
        color: #FFD700;
        min-height: 20px;
    }
    
    /* Current Digit Display */
    #currentDigitDisplay {
        text-align: center;
        margin-top: 10px;
        font-size: 18px;
        color: #A0A0A0;
        min-height: 20px;
    }

    /* Responsive Design */
    @media (max-width: 600px) {
      body { padding: 10px; }
      #gameContainer { padding: 20px; }
      .config, .mode-select, #controlButtons { gap: 10px; margin-bottom: 20px; }
      label { font-size: 14px; }
      input[type="number"] { width: 70px; font-size: 14px; padding: 6px 8px; }
      button { padding: 10px 15px; font-size: 14px; }
      #piDisplay { font-size: 18px; min-height: 110px; max-height: 110px; padding: 15px; }
      .digit { font-size: 18px; }
      #keypad { gap: 10px; max-width: 280px; }
      #keypad button { padding: 20px; font-size: 24px; }
      #timeModeInfo p { font-size: 16px; }
      #currentDigitDisplay { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <h2>円周率暗記ゲーム</h2>

    <div class="config">
      <div class="config-group">
        <label for="startIndex">開始桁数:</label>
        <input type="number" id="startIndex" value="0" min="0">
        <span style="font-size: 14px; color: #888;">（最大: <span id="maxPiLength"></span> 桁）</span>
      </div>
    </div>

    <div class="mode-select">
      <div class="mode-option">
        <input type="radio" id="modeStandard" name="mode" value="standard" checked>
        <label for="modeStandard">標準</label>
      </div>
      <div class="mode-option">
        <input type="radio" id="modeTime" name="mode" value="time">
        <label for="modeTime">タイム</label>
      </div>
      <div class="mode-option">
        <input type="radio" id="modePractice" name="mode" value="practice">
        <label for="modePractice">練習</label>
      </div>
    </div>

    <div id="controlButtons">
      <button id="startBtn">スタート</button>
      <button id="exitBtn">終了</button>
      <button id="resetBtn">リセット</button>
      <button id="memorizeBtn">暗記</button>
    </div>

    <div id="timeModeInfo">
      <p>タイム: <span id="timerDisplay">0.0000</span></p>
      <p>進捗: <span id="progressDigits">0</span>/<span id="targetDigits">102</span></p>
    </div>
    <div id="progressContainer" style="display: none;">
      <div id="progressBar"></div>
    </div>

    <div id="piDisplay"></div>
    <div id="currentDigitDisplay"></div>
    <div id="message"></div>

    <div id="keypad">
      <button class="key">7</button>
      <button class="key">8</button>
      <button class="key">9</button>
      <button class="key">4</button>
      <button class="key">5</button>
      <button class="key">6</button>
      <button class="key">1</button>
      <button class="key">2</button>
      <button class="key">3</button>
      <button class="key">.</button>
      <button class="key">0</button>
      <button class="key" id="clearButton">C</button>
    </div>

    <div id="rankingContainer" style="display: none;">
      <h3>タイムモードランキング</h3>
      <ul id="rankingList">
      </ul>
      <button id="clearRankingBtn">履歴を削除</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // ガウス＝ルジャンドル法で円周率を計算する関数
      // ユーザーが入力した桁数まで計算
      function calculatePi(digits) {
        // Big.jsライブラリを使用して高精度計算を行う
        // 外部スクリプトの動的読み込み
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/big.js@6.2.1/big.min.js';
          script.onload = () => {
            try {
              // Big.jsの設定
              Big.DP = digits + 2; // 指定桁数より少し多めに計算して丸め誤差をなくす

              let a = new Big(1);
              let b = new Big(1).div(new Big(2).sqrt());
              let t = new Big(1).div(4);
              let p = new Big(1);
              let pi = new Big(0);

              let a_next, b_next;
              
              for (let i = 0; i < 10; i++) { // 10回の反復で十分な精度
                a_next = a.add(b).div(2);
                b_next = a.mul(b).sqrt();
                t = t.minus(p.mul(a.minus(a_next).pow(2)));
                a = a_next;
                b = b_next;
                p = p.mul(2);
                pi = a.add(b).pow(2).div(t.mul(4));
              }

              resolve(pi.toFixed(digits));
            } catch (e) {
              reject(e);
            }
          };
          script.onerror = () => {
            reject(new Error('Big.jsライブラリの読み込みに失敗しました。'));
          };
          document.head.appendChild(script);
        });
      }

      let pi = ""; // 計算された円周率を格納する変数
      const desiredDigits = 1002; // 計算したい桁数

      // ページ読み込み時に円周率を計算
      calculatePi(desiredDigits).then(result => {
        pi = result;
        const MAXPIDIGITS = pi.length;
        maxPiLengthSpan.textContent = MAXPIDIGITS;
        loadSettings();
      }).catch(error => {
        console.error("円周率の計算に失敗しました:", error);
        alert("円周率の計算に失敗しました。ページを再読み込みしてください。");
      });

      const GAMEDIGITSPER_LINE = 20;
      const MEMORIZEDIGITSPER_LINE = 20;
      const MEMORIZEBLOCKSIZE = 100;
      const GROUP_SIZE = 2;
      const INDENT_DIGITS = 2;
      const TIMEMODETARGET_DIGITS = 102;

      let targetCount = 1002;
      let startIndex = 0;
      let currentIndex = 0;
      let digitsHistory = [];
      let totalWrongAttempts = 0;

      let gameMode = "standard"; // "standard", "time", "practice"
      let gameActive = false;
      let startTime;
      let ranking = [];
      let timerInterval;

      // エレメントの取得
      const startIndexInput = document.getElementById("startIndex");
      const maxPiLengthSpan = document.getElementById("maxPiLength");
      const modeStandardRadio = document.getElementById("modeStandard");
      const modeTimeRadio = document.getElementById("modeTime");
      const modePracticeRadio = document.getElementById("modePractice");
      const startBtn = document.getElementById("startBtn");
      const exitBtn = document.getElementById("exitBtn");
      const resetBtn = document.getElementById("resetBtn");
      const memorizeBtn = document.getElementById("memorizeBtn");
      const piDisplay = document.getElementById("piDisplay");
      const messageDiv = document.getElementById("message");
      const currentDigitDisplay = document.getElementById("currentDigitDisplay");
      const rankingContainer = document.getElementById("rankingContainer");
      const rankingList = document.getElementById("rankingList");
      const clearRankingBtn = document.getElementById("clearRankingBtn");
      const keypadButtons = document.querySelectorAll(".key");

      const timeModeInfoDiv = document.getElementById("timeModeInfo");
      const timerDisplay = document.getElementById("timerDisplay");
      const progressDigitsSpan = document.getElementById("progressDigits");
      const targetDigitsSpan = document.getElementById("targetDigits");
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById("progressBar");

      const correctSound = new Audio('https://cdn.jsdelivr.net/gh/Tonejs/Tone.js/examples/audio/context/success.mp3'); 
      const wrongSound = new Audio('https://cdn.jsdelivr.net/gh/Tonejs/Tone.js/examples/audio/context/fail.mp3');   


      function saveSettings() {
        localStorage.setItem('piGameStartIndex', startIndexInput.value);
        localStorage.setItem('piGameMode', document.querySelector('input[name="mode"]:checked').value);
      }

      function loadSettings() {
        const savedStartIndex = localStorage.getItem('piGameStartIndex');
        if (savedStartIndex !== null) {
          startIndexInput.value = savedStartIndex;
        }

        const savedMode = localStorage.getItem('piGameMode');
        if (savedMode) {
          const radio = document.getElementById('mode' + savedMode.charAt(0).toUpperCase() + savedMode.slice(1));
          if (radio) {
            radio.checked = true;
            gameMode = savedMode;
          } else {
             modeStandardRadio.checked = true;
             gameMode = "standard";
          }
        }
        
        loadRanking();
        updateModeSettingsVisibility();
      }

      function loadRanking() {
        const savedRanking = localStorage.getItem('piGameRanking');
        ranking = savedRanking ? JSON.parse(savedRanking) : [];
        displayRanking();
      }

      function saveRanking() {
        localStorage.setItem('piGameRanking', JSON.stringify(ranking));
        displayRanking();
      }

      function displayRanking() {
        rankingList.innerHTML = '';
        if (ranking.length === 0) {
          rankingList.innerHTML = '<li>まだ記録がありません。</li>';
          return;
        }
        ranking.sort((a, b) => a.time - b.time);
        ranking.slice(0, 5).forEach((record, index) => {
          const listItem = document.createElement('li');
          const timeFormatted = (record.time / 1000).toFixed(4);
          const date = new Date(record.date);
          const dateFormatted = date.toLocaleString('ja-JP', {
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
          });
          listItem.innerHTML = `
            <span>${index + 1}. ${timeFormatted}秒</span>
            <span class="ranking-details">(${record.wrongAttempts}ミス) ${dateFormatted}</span>
          `;
          rankingList.appendChild(listItem);
        });
      }

      function addRankingEntry(time, wrongAttempts) {
        ranking.push({ time: time, wrongAttempts: wrongAttempts, date: new Date().toISOString() });
        saveRanking();
      }

      function clearRanking() {
        if (confirm("ランキング履歴を全て削除しますか？")) {
          ranking = [];
          saveRanking();
          messageDiv.textContent = "ランキング履歴を削除しました。";
        }
      }

      function updateModeSettingsVisibility() {
          const currentMode = document.querySelector('input[name="mode"]:checked').value;
          gameMode = currentMode;

          startIndexInput.disabled = (currentMode === "time");
          maxPiLengthSpan.parentElement.style.visibility = (currentMode === "time") ? 'hidden' : 'visible';

          rankingContainer.style.display = (currentMode === "time") ? 'block' : 'none';
          
          timeModeInfoDiv.style.display = (currentMode === "time") ? 'flex' : 'none';
          progressContainer.style.display = (currentMode === "time") ? 'block' : 'none';

          if (currentMode !== "time") {
            clearInterval(timerInterval);
            timerDisplay.textContent = "0.0000";
            progressBar.style.width = "0%";
            progressDigitsSpan.textContent = "0";
          }
          
          saveSettings();
          piDisplay.innerHTML = "";
          messageDiv.textContent = "";
          currentDigitDisplay.textContent = "";
          gameActive = false;
          highlightNextKey();
      }
      
      function highlightNextKey() {
        keypadButtons.forEach(btn => {
            btn.classList.remove('practice-highlight');
        });

        if (!gameActive || gameMode !== "practice") {
            return;
        }

        if (currentIndex >= startIndex + targetCount) {
            return;
        }

        const nextDigit = pi.charAt(currentIndex);
        for (const btn of keypadButtons) {
            if (btn.textContent === nextDigit) {
                btn.classList.add('practice-highlight');
                break;
            }
        }
      }

      function updateDisplay() {
        updateStandardTimeDisplay();
        updateCurrentDigitInfo();

        if (gameMode === "time" && gameActive) {
            const completedDigits = currentIndex - 2;
            progressDigitsSpan.textContent = Math.max(0, completedDigits);
            const progressPercentage = (Math.max(0, completedDigits) / (TIMEMODETARGET_DIGITS - 2)) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
      }

      function updateCurrentDigitInfo() {
          if (gameActive