<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£’ç§»å‹•ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .game-board {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 40px 0;
            min-height: 200px;
        }

        .digit-container, .operator-container {
            position: relative;
            width: 80px; /* æ•°å­—ã¨æ¼”ç®—å­ã®ã‚³ãƒ³ãƒ†ãƒŠã®å¹…ã‚’çµ±ä¸€ */
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ¼”ç®—å­ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã®èª¿æ•´ */
        .operator-container .stick {
            position: absolute;
        }


        .stick {
            position: absolute;
            background: #ffd700;
            border: 2px solid #ffed4e;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .stick:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }

        .stick.dragging {
            opacity: 0.6;
            z-index: 1000;
            transform: scale(1.1);
        }

        .empty-slot {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .horizontal {
            width: 50px;
            height: 8px;
        }

        .vertical {
            width: 8px;
            height: 50px;
        }

        /* æ¼”ç®—å­ã®æ£’ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
        .operator-container .horizontal {
            width: 50px;
            height: 8px;
        }
        .operator-container .vertical {
            width: 8px;
            height: 50px;
        }


        .controls {
            text-align: center;
            margin-top: 30px;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .message {
            text-align: center;
            margin: 20px 0;
            font-size: 1.3em;
            font-weight: bold;
            min-height: 30px;
        }

        .success {
            color: #4CAF50;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .error {
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hint {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.1em;
            text-align: center;
        }

        .answer-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            font-size: 1.3em;
            text-align: center;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            max-width: 500px;
            color: #d4eaff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ğŸ§© æ£’ç§»å‹•ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </h1>
            <p>æ£’ã‚’å‹•ã‹ã—ã¦æ­£ã—ã„æ•°å¼ã‚’ä½œã‚ã†ï¼</p>
        </div>

        <div class="game-info">
            <div>ãƒ¬ãƒ™ãƒ«: <span id="level">1</span></div>
            <div>ç§»å‹•å¯èƒ½: <span id="moves-left">1</span>æœ¬</div>
            <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
        </div>

        <div class="game-board" id="game-board">
            </div>

        <div class="message" id="message"></div>

        <div class="controls">
            <button onclick="resetLevel()">ãƒªã‚»ãƒƒãƒˆ</button>
            <button id="next-btn" onclick="nextLevel()" disabled>æ¬¡ã®ãƒ¬ãƒ™ãƒ«</button>
            <button onclick="showHint()">ãƒ’ãƒ³ãƒˆ</button>
            <button onclick="showAnswer()">ç­”ãˆã‚’è¦‹ã‚‹</button>
        </div>

        <div id="hint" class="hint" style="display: none;"></div>
        <div id="answer-display" class="answer-display"></div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentLevel = 1;
        let score = 0;
        let movesLeft = 0;
        let draggedStick = null;
        let dragOffset = { x: 0, y: 0 };
        let originalStickState = null; // æ£’ã®å…ƒã®ä½ç½®ã¨çŠ¶æ…‹ã‚’ä¿å­˜

        // ãƒ¬ãƒ™ãƒ«å®šç¾©
        const levels = [
            { equation: "1+1=3", solution: "1+1=2", moves: 1, hint: "å³ã®æ•°å­—ã€Œ3ã€ã‚’ã€Œ2ã€ã«å¤‰ãˆã‚‹ãŸã‚ã€3ã®å³ä¸‹ã®æ£’ã‚’å–ã‚Šé™¤ãã¾ã—ã‚‡ã†ã€‚", moves_description: "3ã®å³ä¸‹ã®æ£’ã‚’å–ã‚Šé™¤ãã€ç©ºã„ãŸå³ä¸Šã®ã‚¹ãƒšãƒ¼ã‚¹ã«ç§»å‹•ã•ã›ã‚‹ã¨ã€ã€Œ2ã€ã«ãªã‚Šã¾ã™ã€‚" },
            { equation: "2-1=2", solution: "2+1=3", moves: 1, hint: "ã€Œ-ã€ã‚’ã€Œ+ã€ã«å¤‰ãˆã‚‹ãŸã‚ã€ç¸¦ã®æ£’ã‚’æ¨ªã«ç§»å‹•ã—ã¾ã—ã‚‡ã†ã€‚", moves_description: "ã€Œ-ã€ã®æ¨ªæ£’ã‚’ä¸­å¤®ã«ç§»å‹•ã•ã›ã€ã€Œ+ã€è¨˜å·ã‚’å½¢æˆã—ã¾ã™ã€‚ãã†ã™ã‚‹ã¨ã€2+1=3ã¨ã„ã†æ­£ã—ã„å¼ã«ãªã‚Šã¾ã™ã€‚" },
            { equation: "3+3=8", solution: "3+3=6", moves: 1, hint: "å³ã®ã€Œ8ã€ã‚’ã€Œ6ã€ã«å¤‰ãˆã‚‹ãŸã‚ã€8ã®å³ä¸Šã®ç¸¦æ£’ã‚’å–ã‚Šé™¤ãã¾ã—ã‚‡ã†ã€‚", moves_description: "å³ã®ã€Œ8ã€ã‹ã‚‰å³ä¸Šã®ç¸¦æ£’ã‚’å–ã‚Šé™¤ãã€ç©ºã„ãŸã‚¹ãƒšãƒ¼ã‚¹ã«ç§»å‹•ã•ã›ã‚‹ã“ã¨ã§ã€ã€Œ6ã€ã«ãªã‚Šã¾ã™ã€‚" },
            { equation: "6-4=3", solution: "5-4=1", moves: 1, hint: "å·¦ã®ã€Œ6ã€ã‚’ã€Œ5ã€ã«å¤‰ãˆã€ãã®æ£’ã§å³ã®ã€Œ3ã€ã‚’ã€Œ1ã€ã«å¤‰ãˆã¾ã—ã‚‡ã†ã€‚", moves_description: "å·¦ã®ã€Œ6ã€ã®å·¦ä¸Šã®æ£’ã‚’å–ã‚Šé™¤ãã€Œ5ã€ã«ã—ã€ãã®æ£’ã‚’ã€Œ3ã€ã®çœŸã‚“ä¸­ã®æ£’ã®å³å´ã«ç½®ãã“ã¨ã§ã€Œ1ã€ã«ãªã‚Šã¾ã™ã€‚"},
            { equation: "8+1=6", solution: "5+1=6", moves: 2, hint: "ã€Œ8ã€ã‚’ã€Œ5ã€ã«å¤‰ãˆã‚‹ã“ã¨ã¨ã€æ£’ã‚’2æœ¬ç§»å‹•ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚", moves_description: "ã€Œ8ã€ã‹ã‚‰2æœ¬ã®æ£’ã‚’å–ã‚Šé™¤ãã€Œ5ã€ã«ã—ã¾ã™ã€‚å–ã‚Šé™¤ã„ãŸæ£’ã®ã†ã¡1æœ¬ã‚’ã€Œ+ã€è¨˜å·ã®æ¨ªæ£’ã®å³å´ã«ç½®ãã“ã¨ã§ã€Œ6ã€ã«ãªã‚Šã¾ã™ã€‚ã‚‚ã†1æœ¬ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚" },
            { equation: "5+5=9", solution: "5+5=10", moves: 1, hint: "å³ã®ã€Œ9ã€ã‚’ã€Œ10ã€ã«å¤‰ãˆã‚‹ãŸã‚ã€æ£’ã‚’ç§»å‹•ã•ã›ã¾ã—ã‚‡ã†ã€‚", moves_description: "å³ã®ã€Œ9ã€ã®å·¦ä¸‹ã®æ£’ã‚’å–ã‚Šé™¤ãã€Œ0ã€ã«ã—ã¾ã™ã€‚ãã®æ£’ã‚’å·¦ã®ã€Œ5ã€ã®å·¦å´ã«ç½®ãã“ã¨ã§ã€Œ1ã€ã«ãªã‚Šã€ã€Œ10ã€ã«ãªã‚Šã¾ã™ã€‚" },
            { equation: "7-2=6", solution: "9-2=7", moves: 1, hint: "ã€Œ7ã€ã‚’ã€Œ9ã€ã«å¤‰ãˆã‚‹ãŸã‚ã€æ£’ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚", moves_description: "ã€Œ7ã€ã®ä¸‹ã®æ£’ã‚’å·¦ä¸‹ã«ç§»ã™ã“ã¨ã§ã€Œ9ã€ã«ãªã‚Šã¾ã™ã€‚"},
            { equation: "4+4=7", solution: "4+4=8", moves: 1, hint: "å³ã®ã€Œ7ã€ã‚’ã€Œ8ã€ã«å¤‰ãˆã‚‹ãŸã‚ã€æ£’ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚", moves_description: "å³ã®ã€Œ7ã€ã®ä¸­å¤®ä¸Šéƒ¨ã«æ£’ã‚’è¿½åŠ ã—ã€ã€Œ8ã€ã«å¤‰ãˆã¾ã™ã€‚" }
        ];

        // 7ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°å­—ã®å®šç¾©
        const digitPatterns = {
            '0': [1, 1, 1, 1, 1, 1, 0], // ä¸Šã€å³ä¸Šã€å³ä¸‹ã€ä¸‹ã€å·¦ä¸‹ã€å·¦ä¸Šã€ä¸­å¤®
            '1': [0, 1, 1, 0, 0, 0, 0],
            '2': [1, 1, 0, 1, 1, 0, 1],
            '3': [1, 1, 1, 1, 0, 0, 1],
            '4': [0, 1, 1, 0, 0, 1, 1],
            '5': [1, 0, 1, 1, 0, 1, 1],
            '6': [1, 0, 1, 1, 1, 1, 1],
            '7': [1, 1, 1, 0, 0, 0, 0],
            '8': [1, 1, 1, 1, 1, 1, 1],
            '9': [1, 1, 1, 1, 0, 1, 1]
        };

        // æ£’ã®ä½ç½®å®šç¾© (æ•°å­—ç”¨)
        const stickPositions = [
            { x: 15, y: 0, class: 'horizontal' },   // ä¸Š (0)
            { x: 60, y: 15, class: 'vertical' },    // å³ä¸Š (1)
            { x: 60, y: 55, class: 'vertical' },    // å³ä¸‹ (2)
            { x: 15, y: 100, class: 'horizontal' }, // ä¸‹ (3)
            { x: 0, y: 55, class: 'vertical' },     // å·¦ä¸‹ (4)
            { x: 0, y: 15, class: 'vertical' },     // å·¦ä¸Š (5)
            { x: 15, y: 50, class: 'horizontal' }   // ä¸­å¤® (6)
        ];

        // æ¼”ç®—å­ã®å®šç¾©
        const operatorPatterns = {
            '+': [
                { x: 20, y: 50, class: 'horizontal' }, // æ¨ªæ£’
                { x: 35, y: 30, class: 'vertical' }   // ç¸¦æ£’ (ä¿®æ­£ï¼šç¸¦æ£’ã®Yåº§æ¨™ã‚’èª¿æ•´ã—ã¦ä¸­å¤®ã«)
            ],
            '-': [
                { x: 20, y: 50, class: 'horizontal' }
            ],
            '=': [
                { x: 15, y: 40, class: 'horizontal' },
                { x: 15, y: 60, class: 'horizontal' }
            ]
        };

        function initGame() {
            loadLevel(currentLevel);
        }

        function loadLevel(level) {
            const levelData = levels[level - 1];
            if (!levelData) {
                showMessage("ğŸ‰ å…¨ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼", "success");
                document.getElementById('next-btn').disabled = true;
                return;
            }

            movesLeft = levelData.moves;
            updateDisplay();
            createGameBoard(levelData.equation);
            showMessage("");
            document.getElementById('next-btn').disabled = true;
            document.getElementById('answer-display').style.display = 'none'; // æ–°ã—ã„ãƒ¬ãƒ™ãƒ«ã§ç­”ãˆã‚’éè¡¨ç¤ºã«ã™ã‚‹
        }

        function createGameBoard(equation) {
            const board = document.getElementById('game-board');
            board.innerHTML = '';

            for (let i = 0; i < equation.length; i++) {
                const char = equation[i];
                if (char >= '0' && char <= '9') {
                    board.appendChild(createDigit(char, i));
                } else if (char === '+' || char === '-' || char === '=') {
                    board.appendChild(createOperator(char, i));
                }
            }
            saveOriginalStickState(); // ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ä½œæˆæ™‚ã«å…ƒã®çŠ¶æ…‹ã‚’ä¿å­˜
        }

        function createDigit(digit, index) {
            const container = document.createElement('div');
            container.className = 'digit-container';
            container.dataset.index = index;
            container.dataset.type = 'digit';

            const pattern = digitPatterns[digit];
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ£’ã‚’ä½œæˆ
            pattern.forEach((active, stickIndex) => {
                const pos = stickPositions[stickIndex];
                if (active) {
                    const stick = createStick(pos, `${index}-${stickIndex}`, true);
                    container.appendChild(stick);
                } else {
                    // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ­ãƒƒãƒˆã‚‚ä½œæˆ
                    const slot = createEmptySlot(pos, `${index}-${stickIndex}`);
                    container.appendChild(slot);
                }
            });

            return container;
        }

        function createOperator(operator, index) {
            const container = document.createElement('div');
            container.className = 'operator-container';
            container.dataset.index = index;
            container.dataset.type = 'operator';

            const pattern = operatorPatterns[operator];
            
            // æ¼”ç®—å­ã®æ£’ã‚’ä½œæˆ
            pattern.forEach((pos, stickIndex) => {
                const stick = createStick(pos, `${index}-${stickIndex}`, true);
                container.appendChild(stick);
            });

            // æ¼”ç®—å­ã®ç©ºã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆ (å¿…è¦ã«å¿œã˜ã¦)
            // ä¾‹ãˆã° '+' ã«ã¯ç¸¦æ¨ª2æœ¬ã€'-' ã«ã¯æ¨ª1æœ¬ã€'=' ã«ã¯æ¨ª2æœ¬
            // ãã‚Œä»¥å¤–ã®å ´æ‰€ã¯ç©ºã‚¹ãƒ­ãƒƒãƒˆã¨ã¿ãªã™ã“ã¨ãŒã§ãã‚‹
            const allOperatorSlots = {
                '+': [ // æ¨ªæ£’ã¨ç¸¦æ£’
                    { x: 20, y: 50, class: 'horizontal' },
                    { x: 35, y: 30, class: 'vertical' }
                ],
                '-': [ // æ¨ªæ£’
                    { x: 20, y: 50, class: 'horizontal' }
                ],
                '=': [ // ä¸Šæ®µã¨ä¸‹æ®µã®æ¨ªæ£’
                    { x: 15, y: 40, class: 'horizontal' },
                    { x: 15, y: 60, class: 'horizontal' }
                ]
            };
            const currentOperatorSlots = allOperatorSlots[operator] || [];

            // ã™ã¹ã¦ã®å¯èƒ½ãªã‚¹ãƒ­ãƒƒãƒˆã‚’å®šç¾©ã—ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ£’ã®ä½ç½®ã‚’é™¤å¤–ã—ã¦ç©ºã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
            // ä¾‹: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­å¤®ä»˜è¿‘ã‚’åŸºæº–ã«ç©ºã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
            const operatorEmptySlots = [
                { x: 20, y: 50, class: 'horizontal' }, // - ã®ä½ç½®ã€+ ã®æ¨ªæ£’ã®ä½ç½®
                { x: 35, y: 30, class: 'vertical' },   // + ã®ç¸¦æ£’ã®ä½ç½®
                { x: 15, y: 40, class: 'horizontal' }, // = ã®ä¸Šæ®µã®ä½ç½®
                { x: 15, y: 60, class: 'horizontal' }  // = ã®ä¸‹æ®µã®ä½ç½®
            ];

            operatorEmptySlots.forEach((slotPos, slotIndex) => {
                const isOccupied = pattern.some(p => p.x === slotPos.x && p.y === slotPos.y && p.class === slotPos.class);
                if (!isOccupied) {
                    const slot = createEmptySlot(slotPos, `${index}-op-slot-${slotIndex}`);
                    container.appendChild(slot);
                }
            });


            return container;
        }

        function createStick(position, id, active) {
            const stick = document.createElement('div');
            stick.className = `stick ${position.class}`;
            stick.style.left = position.x + 'px';
            stick.style.top = position.y + 'px';
            stick.dataset.id = id;
            stick.dataset.active = active;
            stick.dataset.originalX = position.x;
            stick.dataset.originalY = position.y;
            stick.dataset.originalClass = position.class; // å…ƒã®ã‚¯ãƒ©ã‚¹ã‚‚ä¿å­˜

            if (active) {
                addStickEvents(stick);
            }
            
            return stick;
        }

        function createEmptySlot(position, id) {
            const slot = document.createElement('div');
            slot.className = `empty-slot ${position.class}`;
            slot.style.left = position.x + 'px';
            slot.style.top = position.y + 'px';
            slot.dataset.id = id;
            slot.dataset.x = position.x;
            slot.dataset.y = position.y;
            slot.dataset.class = position.class;
            
            slot.addEventListener('dragover', handleDragOver);
            slot.addEventListener('drop', handleDrop);
            
            return slot;
        }

        function addStickEvents(stick) {
            stick.draggable = true;
            stick.addEventListener('dragstart', handleDragStart);
            stick.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            if (movesLeft <= 0) {
                e.preventDefault();
                return;
            }
            
            draggedStick = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';

            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æ£’ã®å…ƒã®æƒ…å ±ã‚’ä¿å­˜
            draggedStick.dataset.originalParentId = draggedStick.parentNode.dataset.index;
            draggedStick.dataset.originalSlotId = draggedStick.dataset.id;
            
            // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«ã€å…ƒã®ä½ç½®ã«ä»®ã®ç©ºã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
            const sourceContainer = draggedStick.parentNode;
            const sourcePos = {
                x: parseInt(draggedStick.style.left),
                y: parseInt(draggedStick.style.top),
                class: draggedStick.classList.contains('horizontal') ? 'horizontal' : 'vertical'
            };
            const tempSlot = createEmptySlot(sourcePos, draggedStick.dataset.id);
            tempSlot.dataset.temp = 'true'; // ä»®ã®ã‚¹ãƒ­ãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
            sourceContainer.appendChild(tempSlot);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            
            // ãƒ‰ãƒ©ãƒƒã‚°ãŒå®Œäº†ã—ãŸã¨ãã«ã€å…ƒã®ä½ç½®ã®ä»®ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤
            const tempSlot = document.querySelector('.empty-slot[data-temp="true"]');
            if (tempSlot) {
                tempSlot.remove();
            }
            draggedStick = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (!draggedStick || movesLeft <= 0) return;

            const targetSlot = e.target.closest('.empty-slot');
            if (!targetSlot) return;

            // ç§»å‹•å…ˆã®ã‚¹ãƒ­ãƒƒãƒˆã¨æ£’ã®ã‚¯ãƒ©ã‚¹ï¼ˆæ°´å¹³/å‚ç›´ï¼‰ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
            if (draggedStick.classList.contains('horizontal') !== targetSlot.classList.contains('horizontal') ||
                draggedStick.classList.contains('vertical') !== targetSlot.classList.contains('vertical')) {
                // ã‚¯ãƒ©ã‚¹ãŒä¸€è‡´ã—ãªã„å ´åˆã¯ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ç„¡åŠ¹ã«ã™ã‚‹
                showMessage("æ£’ã®ç¨®é¡ãŒåˆã„ã¾ã›ã‚“ï¼", "error");
                return;
            }

            const sourceContainer = draggedStick.parentNode;
            const targetContainer = targetSlot.parentNode;

            // å…ƒã®ä½ç½®ã®ä»®ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤
            const tempSlot = document.querySelector('.empty-slot[data-temp="true"]');
            if (tempSlot) {
                tempSlot.remove();
            }

            // å…ƒã®ä½ç½®ã«æ–°ã—ã„ç©ºã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
            const sourcePos = {
                x: parseInt(draggedStick.style.left),
                y: parseInt(draggedStick.style.top),
                class: draggedStick.classList.contains('horizontal') ? 'horizontal' : 'vertical'
            };
            const sourceSlot = createEmptySlot(sourcePos, draggedStick.dataset.id); // å…ƒã®æ£’ã®IDã‚’ä½¿ç”¨
            sourceContainer.appendChild(sourceSlot);

            // æ£’ã‚’æ–°ã—ã„ä½ç½®ã«ç§»å‹•
            draggedStick.style.left = targetSlot.style.left;
            draggedStick.style.top = targetSlot.style.top;
            // æ–°ã—ã„ä½ç½®ã®IDã‚’æ£’ã«è¨­å®š
            draggedStick.dataset.id = targetSlot.dataset.id;
            
            targetContainer.appendChild(draggedStick);
            targetSlot.remove(); // ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤

            movesLeft--;
            updateDisplay();

            if (movesLeft === 0) {
                setTimeout(checkSolution, 100);
            }
        }

        function saveOriginalStickState() {
            originalStickState = [];
            document.querySelectorAll('.digit-container, .operator-container').forEach(container => {
                const containerId = container.dataset.index;
                container.querySelectorAll('.stick').forEach(stick => {
                    originalStickState.push({
                        id: stick.dataset.id,
                        parentIndex: containerId,
                        x: parseInt(stick.style.left),
                        y: parseInt(stick.style.top),
                        class: stick.classList.contains('horizontal') ? 'horizontal' : 'vertical'
                    });
                });
            });
        }

        function checkSolution() {
            const equation = getCurrentEquation();
            const currentLevelData = levels[currentLevel - 1];
            
            try {
                // ç­‰å·ã§åˆ†å‰²
                const parts = equation.split('=');
                if (parts.length !== 2) {
                    showFailure();
                    return;
                }

                const leftSide = parts[0].trim();
                const rightSide = parseInt(parts[1].trim());

                // å·¦è¾ºã‚’è©•ä¾¡
                const leftResult = eval(leftSide);
                
                if (leftResult === rightSide) {
                    showSuccess();
                } else {
                    showFailure();
                }
            } catch (error) {
                showFailure();
            }
        }

        function getCurrentEquation() {
            const containers = document.querySelectorAll('.digit-container, .operator-container');
            let equation = '';
            
            // ã‚³ãƒ³ãƒ†ãƒŠã®data-indexå±æ€§ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆ
            const sortedContainers = Array.from(containers).sort((a, b) => {
                return parseInt(a.dataset.index) - parseInt(b.dataset.index);
            });

            sortedContainers.forEach(container => {
                if (container.classList.contains('digit-container')) {
                    equation += getDigitFromContainer(container);
                } else if (container.classList.contains('operator-container')) {
                    equation += getOperatorFromContainer(container);
                }
            });

            return equation;
        }

        function getDigitFromContainer(container) {
            const activeSticks = Array.from(container.querySelectorAll('.stick')).map(stick => {
                const idPart = stick.dataset.id.split('-');
                // IDã®æœ€å¾Œã®éƒ¨åˆ†ãŒæ•°å­—ã®æ£’ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œ
                return parseInt(idPart[idPart.length - 1]);
            });

            // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
            for (let digit in digitPatterns) {
                const pattern = digitPatterns[digit];
                let matches = true;
                
                for (let i = 0; i < 7; i++) {
                    const shouldBeActive = pattern[i] === 1;
                    const isActive = activeSticks.includes(i);
                    
                    if (shouldBeActive !== isActive) {
                        matches = false;
                        break;
                    }
                }
                
                if (matches) {
                    return digit;
                }
            }
            
            return '?'; // ä¸æ˜ãªæ•°å­—
        }

        function getOperatorFromContainer(container) {
            const activeSticks = Array.from(container.querySelectorAll('.stick'));
            
            if (activeSticks.length === 1) {
                const stick = activeSticks[0];
                if (stick.classList.contains('horizontal')) {
                    // '-'(ãƒã‚¤ãƒŠã‚¹)ã¾ãŸã¯'='ã®ç‰‡æ–¹
                    // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã¨æ£’ã®ä½ç½®ã«åŸºã¥ã„ã¦åˆ¤æ–­
                    if (parseInt(stick.style.left) === 20 && parseInt(stick.style.top) === 50) {
                        return '-'; // é€šå¸¸ã®ãƒã‚¤ãƒŠã‚¹ã®ä½ç½®
                    }
                }
            } else if (activeSticks.length === 2) {
                let hasHorizontal = 0;
                let hasVertical = 0;
                
                activeSticks.forEach(stick => {
                    if (stick.classList.contains('horizontal')) {
                        hasHorizontal++;
                    } else if (stick.classList.contains('vertical')) {
                        hasVertical++;
                    }
                });

                if (hasHorizontal === 2 && hasVertical === 0) {
                    return '=';
                } else if (hasHorizontal === 1 && hasVertical === 1) {
                    return '+';
                }
            }
            
            return '?'; // ä¸æ˜ãªæ¼”ç®—å­
        }

        function showSuccess() {
            score += currentLevel * 100;
            showMessage("ğŸ‰ æ­£è§£ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼", "success");
            document.getElementById('next-btn').disabled = false;
            updateDisplay();
        }

        function showFailure() {
            showMessage("å¤±æ•—ï¼ãƒªã‚»ãƒƒãƒˆã—ã¦å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ã€‚", "error");
        }

        function showMessage(text, className = "") {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = `message ${className}`;
        }

        function updateDisplay() {
            document.getElementById('level').textContent = currentLevel;
            document.getElementById('moves-left').textContent = movesLeft;
            document.getElementById('score').textContent = score;
        }

        function resetLevel() {
            loadLevel(currentLevel);
            document.getElementById('hint').style.display = 'none';
            document.getElementById('answer-display').style.display = 'none';
        }

        function nextLevel() {
            currentLevel++;
            loadLevel(currentLevel);
            document.getElementById('hint').style.display = 'none';
            document.getElementById('answer-display').style.display = 'none';
        }

        function showHint() {
            const levelData = levels[currentLevel - 1];
            if (levelData) {
                const hintElement = document.getElementById('hint');
                hintElement.textContent = `ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ${levelData.hint}`;
                hintElement.style.display = 'block';
                document.getElementById('answer-display').style.display = 'none'; // ãƒ’ãƒ³ãƒˆè¡¨ç¤ºæ™‚ã¯ç­”ãˆã‚’éè¡¨ç¤ºã«ã™ã‚‹
            }
        }

        function showAnswer() {
            const levelData = levels[currentLevel - 1];
            if (levelData) {
                const answerElement = document.getElementById('answer-display');
                answerElement.innerHTML = `
                    <p>æ­£è§£ã®å¼: <span style="color: #FFD700;">${levelData.solution}</span></p>
                    <p>å‹•ã‹ã—æ–¹: ${levelData.moves_description}</p>
                `;
                answerElement.style.display = 'block';
                document.getElementById('hint').style.display = 'none'; // ç­”ãˆè¡¨ç¤ºæ™‚ã¯ãƒ’ãƒ³ãƒˆã‚’éè¡¨ç¤ºã«ã™ã‚‹
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        initGame();
    </script>
</body>
</html>
